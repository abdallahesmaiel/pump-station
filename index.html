<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام محطات الضخ - قاعدة بيانات سحابية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        /* رأس الصفحة */
        .main-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1d3d75 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .main-header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-header h1 i {
            margin-left: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.3rem;
            margin-bottom: 25px;
        }
        
        /* حالة الاتصال */
        .connection-status {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 25px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            margin-top: 15px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4cd964;
            box-shadow: 0 0 10px #4cd964;
        }
        
        .status-dot.offline {
            background: #ff3b30;
            box-shadow: 0 0 10px #ff3b30;
        }
        
        /* قسم الكروت */
        .cards-section {
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: none;
        }
        
        .cards-section.active {
            display: block;
        }
        
        .section-title {
            text-align: center;
            color: #2c5aa0;
            margin-bottom: 40px;
            font-size: 2rem;
            position: relative;
            padding-bottom: 15px;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #2c5aa0, #26d0ce);
            border-radius: 2px;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .station-card {
            background: white;
            border-radius: 15px;
            padding: 30px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .station-card:before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #2c5aa0, #26d0ce);
            transform: translateX(100%);
            transition: transform 0.4s;
        }
        
        .station-card:hover:before {
            transform: translateX(0);
        }
        
        .station-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: #2c5aa0;
        }
        
        .station-card.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
            box-shadow: 0 15px 35px rgba(40, 167, 69, 0.2);
        }
        
        .station-icon {
            font-size: 3.5rem;
            color: #2c5aa0;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .station-card:hover .station-icon {
            transform: rotate(15deg) scale(1.1);
        }
        
        .station-id {
            background: linear-gradient(135deg, #2c5aa0 0%, #1d3d75 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 30px;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1.4rem;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
        }
        
        .station-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }
        
        .station-desc {
            color: #666;
            font-size: 1rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .station-status {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }
        
        .station-status.online {
            background: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
            animation: pulse 2s infinite;
        }
        
        /* قسم النموذج */
        .form-section {
            display: none;
            padding: 40px;
            background: white;
            min-height: 100vh;
        }
        
        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .station-header {
            background: linear-gradient(135deg, #1d3d75 0%, #2c5aa0 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 35px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .station-header:before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        
        .station-header h2 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .station-info-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 20px;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        .info-item {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }
        
        .info-item label {
            display: block;
            font-size: 0.95rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .info-item span {
            font-weight: bold;
            font-size: 1.2rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        /* زر العودة */
        .back-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .back-btn:hover {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            transform: translateX(-10px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }
        
        /* بيانات المشغل */
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: linear-gradient(135deg, #eef5ff 0%, #e3ecff 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(44, 90, 160, 0.1);
        }
        
        .header-name {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .info-item-input {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .info-item-input label {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item-input input,
        .info-item-input select {
            padding: 16px 20px;
            border: 2px solid #d1d9e6;
            border-radius: 10px;
            font-size: 1.1rem;
            width: 100%;
            height: 58px;
            transition: all 0.3s;
            background: white;
        }
        
        .info-item-input input:focus,
        .info-item-input select:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 4px rgba(44, 90, 160, 0.2);
            outline: none;
            transform: translateY(-2px);
        }
        
        /* الأزرار */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(44, 90, 160, 0.1);
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 200px;
            height: 60px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .btn:hover:before {
            transform: translateX(100%);
        }
        
        .btn:hover {
            transform: translateY(-5px) scale(1.05);
        }
        
        .btn i {
            font-size: 1.3rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c5aa0 0%, #1d3d75 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.3);
        }
        
        .btn-primary:hover {
            box-shadow: 0 12px 30px rgba(44, 90, 160, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #fd7e14 0%, #e36209 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(253, 126, 20, 0.3);
        }
        
        /* الجدول */
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 30px 0;
            border: 3px solid #e0e7ff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        th, td {
            border: 1px solid #e0e7ff;
            padding: 18px 15px;
            text-align: center;
            font-size: 1rem;
            min-width: 120px;
        }
        
        th {
            background: linear-gradient(135deg, #2c5aa0 0%, #1d3d75 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        tr:nth-child(even) {
            background-color: #f8faff;
        }
        
        tr:hover {
            background-color: #eef5ff;
            transform: scale(1.002);
            transition: transform 0.2s;
        }
        
        .unit-header {
            background: linear-gradient(135deg, #e7f1ff 0%, #d4e3ff 100%) !important;
            font-weight: bold;
            color: #1d3d75;
            font-size: 1.3rem;
            padding: 22px 15px;
        }
        
        .data-input {
            width: 100%;
            padding: 15px 12px;
            border: 2px solid #d1d9e6;
            border-radius: 8px;
            font-size: 1.1rem;
            height: 50px;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }
        
        .data-input:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.2);
            outline: none;
            transform: scale(1.02);
        }
        
        /* البيانات الإضافية */
        .footer-section {
            margin-top: 40px;
            padding: 40px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(44, 90, 160, 0.1);
        }
        
        .section-title-form {
            background: linear-gradient(135deg, #1d3d75 0%, #2c5aa0 100%);
            color: white;
            padding: 25px;
            margin: 35px 0 25px 0;
            border-radius: 15px;
            font-size: 1.4rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .section-title-form:before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .footer-row {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .footer-col {
            width: 100%;
        }
        
        .footer-col label {
            display: block;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1d3d75;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notes {
            margin-top: 30px;
        }
        
        textarea {
            width: 100%;
            padding: 20px;
            border: 2px solid #d1d9e6;
            border-radius: 12px;
            font-size: 1.1rem;
            height: 150px;
            resize: vertical;
            min-height: 150px;
            line-height: 1.6;
            transition: all 0.3s;
            background: white;
        }
        
        textarea:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 4px rgba(44, 90, 160, 0.2);
            outline: none;
        }
        
        /* الإشعارات */
        .notification {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            padding: 25px 45px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
            z-index: 10000;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 400px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #fd7e14 0%, #e36209 100%);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* الفوتر */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            color: #666;
            font-size: 1rem;
            border-top: 3px solid #eef5ff;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        /* شريط التحميل */
        .progress-bar {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #2c5aa0, #26d0ce);
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 10001;
        }
        
        .progress-bar.active {
            animation: loading 2s ease-in-out infinite;
        }
        
        @keyframes loading {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(-50%); }
            100% { transform: translateX(0%); }
        }
        
        /* التجاوب */
        @media (min-width: 768px) {
            .header-info {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .info-item-input {
                flex: 1;
                min-width: 250px;
            }
            
            .header-name {
                flex-direction: row;
                flex: 2;
            }
            
            .controls {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .btn-group {
                flex-wrap: nowrap;
            }
            
            .footer-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .footer-col {
                flex: 1;
                min-width: 250px;
            }
        }
        
        @media (max-width: 767px) {
            .main-header h1 {
                font-size: 2rem;
            }
            
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
            
            .station-info-bar {
                flex-direction: column;
                text-align: center;
            }
            
            .info-item {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .main-header {
                padding: 20px;
            }
            
            .cards-section,
            .form-section {
                padding: 20px;
            }
            
            .station-card {
                padding: 20px;
            }
            
            .notification {
                min-width: 90%;
                padding: 20px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- شريط التحميل -->
    <div class="progress-bar" id="progressBar"></div>

    <div class="container">
        <!-- رأس الصفحة -->
        <div class="main-header">
            <h1><i class="fas fa-water"></i> نظام سجل محطات الضخ</h1>
            <p class="subtitle">نظام سحابي متكامل - يعمل على جميع الأجهزة</p>
            <div class="connection-status" id="connectionStatus">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">جاري الاتصال بقاعدة البيانات...</span>
            </div>
        </div>

        <!-- قسم الكروت -->
        <div class="cards-section active" id="cardsSection">
            <h2 class="section-title"><i class="fas fa-satellite-dish"></i> المحطات المتاحة</h2>
            <div class="cards-grid" id="cardsContainer">
                <!-- الكروت ستتم إضافتها بواسطة JavaScript -->
            </div>
            
            <div style="text-align: center; margin-top: 40px;">
                <button class="btn btn-success" id="newStationBtn">
                    <i class="fas fa-plus-circle"></i> إنشاء محطة جديدة
                </button>
                <button class="btn btn-secondary" id="refreshBtn" style="margin-right: 15px;">
                    <i class="fas fa-sync"></i> تحديث القائمة
                </button>
            </div>
        </div>

        <!-- قسم النموذج -->
        <div class="form-section" id="formSection">
            <!-- زر العودة -->
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-right"></i> العودة إلى القائمة
            </button>

            <!-- معلومات المحطة -->
            <div class="station-header">
                <h2 id="stationTitle"><i class="fas fa-water"></i> محطة جديدة</h2>
                <div class="station-info-bar">
                    <div class="info-item">
                        <label><i class="fas fa-tag"></i> اسم المحطة:</label>
                        <span id="currentStation">غير محدد</span>
                    </div>
                    <div class="info-item">
                        <label><i class="fas fa-user"></i> المشغل الحالي:</label>
                        <span id="currentOperator">غير محدد</span>
                    </div>
                    <div class="info-item">
                        <label><i class="fas fa-clock"></i> آخر تحديث:</label>
                        <span id="lastUpdate">غير متوفر</span>
                    </div>
                    <div class="info-item">
                        <label><i class="fas fa-cloud"></i> الحالة:</label>
                        <span id="syncState">جاهز</span>
                    </div>
                </div>
            </div>

            <!-- بيانات المشغل -->
            <div class="header-info">
                <div class="info-item-input">
                    <label><i class="fas fa-tag"></i> اسم المحطة:</label>
                    <input type="text" id="station-name" class="keyboard-text" placeholder="أدخل اسم المحطة (مثال: S1A)" />
                </div>
                <div class="header-name">
                    <div class="info-item-input">
                        <label><i class="fas fa-user"></i> اسم المشغل:</label>
                        <input type="text" id="operator-name" class="keyboard-text" placeholder="أدخل اسم المشغل" />
                    </div>

                    <div class="info-item-input">
                        <label><i class="fas fa-calendar"></i> التاريخ:</label>
                        <input type="date" id="record-date" />
                    </div>

                    <div class="info-item-input">
                        <label><i class="fas fa-clock"></i> الوردية:</label>
                        <select id="shift">
                            <option value="صباحية">صباحية</option>
                            <option value="مسائية">مسائية</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- أزرار التحكم -->
            <div class="controls">
                <div class="btn-group">
                    <button class="btn btn-primary" id="addRowBtn">
                        <i class="fas fa-plus"></i> إضافة وحدة
                    </button>
                    <button class="btn btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i> إعادة تعيين
                    </button>
                    <button class="btn btn-success" id="saveBtn">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" id="exportBtn">
                        <i class="fas fa-file-excel"></i> تصدير إلى Excel
                    </button>
                    <button class="btn btn-primary" id="printBtn">
                        <i class="fas fa-print"></i> طباعة
                    </button>
                    <button class="btn btn-warning" id="syncBtn">
                        <i class="fas fa-sync"></i> مزامنة البيانات
                    </button>
                </div>
            </div>

            <!-- الجدول الرئيسي -->
            <div class="table-container">
                <table id="pumpTable">
                    <thead>
                        <tr>
                            <th rowspan="2">البيان</th>
                            <th colspan="5">القراءات حسب الوقت</th>
                        </tr>
                        <tr>
                            <th>6:00 ص</th>
                            <th>11:00 ص</th>
                            <th>4:00 م</th>
                            <th>9:00 م</th>
                            <th>2:00 ص</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- البيانات ستتم إضافتها بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- البيانات الإضافية -->
            <div class="footer-section">
                <div class="section-title-form">
                    <i class="fas fa-tachometer-alt"></i> منظومة الطرق المائي و ضاغط الهواء
                </div>

                <div class="footer-row">
                    <div class="footer-col">
                        <label><i class="fas fa-road"></i> الطرق المائي:</label>
                        <input type="text" id="waterPath" class="keyboard-text" placeholder="أدخل حالة الطرق المائي" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-water"></i> مستوي المياه بالخزان الأول:</label>
                        <input type="text" id="tank1Level" class="keyboard-text" placeholder="أدخل المستوي" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-water"></i> مستوي المياه بالخزان الثاني:</label>
                        <input type="text" id="tank2Level" class="keyboard-text" placeholder="أدخل المستوي" />
                    </div>
                </div>

                <div class="footer-row">
                    <div class="footer-col">
                        <label><i class="fas fa-water"></i> مستوي المياه بالخزان الثالث:</label>
                        <input type="text" id="tank3Level" class="keyboard-text" placeholder="أدخل المستوي" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-oil-can"></i> الضاغط الأول / درجة الحرارة:</label>
                        <input type="text" id="compressor1" class="keyboard-text" placeholder="مثال: جيد / 45°C" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-oil-can"></i> الضاغط الثاني / درجة الحرارة:</label>
                        <input type="text" id="compressor2" class="keyboard-text" placeholder="مثال: جيد / 42°C" />
                    </div>
                </div>

                <div class="section-title-form">
                    <i class="fas fa-tachometer-alt"></i> منظومة التحضير
                </div>

                <div class="footer-col" style="width: 100%;">
                    <label><i class="fas fa-compress-arrows-alt"></i> مستوي الزيت بالضاغط / درجة الحرارة:</label>
                    <input type="text" id="com" class="keyboard-text" placeholder="أدخل القراءة" />
                </div>

                <div class="section-title-form">
                    <i class="fas fa-clock"></i> مواعيد التشغيل \ الإيقاف للمحطة
                </div>

                <div class="footer-row">
                    <div class="footer-col">
                        <label><i class="fas fa-play-circle"></i> توقيت تشغيل المحطة:</label>
                        <input type="time" id="startTime" value="06:00" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-stop-circle"></i> توقيت إيقاف المحطة:</label>
                        <input type="time" id="endTime" value="24:00" />
                    </div>
                    <div class="footer-col">
                        <label><i class="fas fa-clock"></i> عدد ساعات التشغيل:</label>
                        <input type="text" id="totalHours" class="keyboard-number" placeholder="سيتم حسابه تلقائياً" readonly />
                    </div>
                </div>

                <div class="notes">
                    <label><i class="fas fa-sticky-note"></i> ملاحظات اليوم:</label>
                    <textarea id="dailyNotes" class="keyboard-text" placeholder="أدخل أي ملاحظات هامة عن تشغيل المحطة اليوم..."></textarea>
                </div>
            </div>

            <!-- الفوتر -->
            <div class="footer">
                <p>نظام سجل محطات الضخ السحابي © 2024 - يعمل على جميع الأجهزة</p>
                <p>تم التطوير باستخدام Supabase - قاعدة بيانات سحابية متكاملة</p>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ========== بيانات Supabase ==========
        const SUPABASE_URL = 'https://gjzjltdodzlhpcgekhcc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqempsdGRvZHpsaHBjZ2VraGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE2OTY5MzIsImV4cCI6MjA0NzI3MjkzMn0.Xwf7XupO6M93M2LwRnIN9Q_KUz2o2Ot';
        
        let supabase = null;
        let currentStation = '';
        let isOnline = false;
        let stationDataCache = {};

        // ========== البيانات الأساسية ==========
        const pumpUnits = [
            {
                name: "معلومات",
                items: [
                    { name: "المنسوب", id: "level1", unit: "سم", inputType: "mixed", placeholder: "أدخل المنسوب" },
                    { name: "قراءة عداد الطاقة", id: "energy1", unit: "ك.و.س", inputType: "number", placeholder: "أدخل القراءة" },
                    { name: "قراءة عداد الطاقة ٢", id: "energy2", unit: "ك.و.س", inputType: "number", placeholder: "أدخل القراءة" },
                    { name: "الجهد", id: "voltage1", unit: "فولت", inputType: "number", placeholder: "أدخل الجهد" },
                    { name: "الضغط", id: "daght", unit: "بار", inputType: "number", placeholder: "أدخل الضغط" }
                ]
            },
            {
                name: "الوحدة رقم ١",
                type: "unit",
                unitNumber: 1,
                items: [
                    { name: "إجمالي عدد الساعات", id: "totalHours1", unit: "ساعة", inputType: "number", placeholder: "أدخل الساعات" },
                    { name: "فتحة محبس الطرد (%)", id: "valve1", unit: "%", inputType: "number", placeholder: "أدخل النسبة" },
                    { name: "ضغط سحب المضخة", id: "suction1", unit: "بار", inputType: "number", placeholder: "أدخل الضغط" },
                    { name: "ضغط طرد المضخة", id: "discharge1", unit: "بار", inputType: "number", placeholder: "أدخل الضغط" },
                    { name: "حالة حرارة كرسي التحميل", id: "bearing1", unit: "°C", inputType: "mixed", placeholder: "أدخل الحرارة" },
                    { name: "حالة الحشو", id: "seal1", unit: "", inputType: "text", placeholder: "أدخل الحالة" },
                    { name: "درجة حرارة الموتور", id: "motorTemp1", unit: "", inputType: "mixed", placeholder: "أدخل الحرارة" },
                    { name: "شدة تيار الموتور", id: "motorCurrent1", unit: "أمبير", inputType: "number", placeholder: "أدخل التيار" }
                ]
            },
            {
                name: "الوحدة رقم ٢",
                type: "unit",
                unitNumber: 2,
                items: [
                    { name: "إجمالي عدد الساعات", id: "totalHours2", unit: "ساعة", inputType: "number", placeholder: "أدخل الساعات" },
                    { name: "فتحة محبس الطرد (%)", id: "valve2", unit: "%", inputType: "number", placeholder: "أدخل النسبة" },
                    { name: "ضغط سحب المضخة", id: "suction2", unit: "بار", inputType: "number", placeholder: "أدخل الضغط" },
                    { name: "ضغط طرد المضخة", id: "discharge2", unit: "بار", inputType: "number", placeholder: "أدخل الضغط" },
                    { name: "حالة حرارة كرسي التحميل", id: "bearing2", unit: "°C", inputType: "mixed", placeholder: "أدخل الحرارة" },
                    { name: "حالة الحشو", id: "seal2", unit: "", inputType: "text", placeholder: "أدخل الحالة" },
                    { name: "درجة حرارة الموتور", id: "motorTemp2", unit: "", inputType: "mixed", placeholder: "أدخل الحرارة" },
                    { name: "شدة تيار الموتور", id: "motorCurrent2", unit: "أمبير", inputType: "number", placeholder: "أدخل التيار" }
                ]
            }
        ];

        const timeSlots = ["6:00", "11:00", "16:00", "21:00", "2:00"];

        const stationCards = [
            { id: "S1A", name: "المحطة الرئيسية A", icon: "fa-water", description: "محطة الضخ الرئيسية - المنطقة A" },
            { id: "S1B", name: "المحطة الرئيسية B", icon: "fa-water", description: "محطة الضخ الرئيسية - المنطقة B" },
            { id: "S3", name: "محطة المنطقة 3", icon: "fa-water", description: "محطة فرعية - المنطقة 3" },
            { id: "S4", name: "محطة المنطقة 4", icon: "fa-water", description: "محطة فرعية - المنطقة 4" },
            { id: "S5A", name: "المحطة الفرعية 5A", icon: "fa-tint", description: "محطة توزيع - المنطقة 5A" },
            { id: "S5B", name: "المحطة الفرعية 5B", icon: "fa-tint", description: "محطة توزيع - المنطقة 5B" },
            { id: "S6", name: "محطة المنطقة 6", icon: "fa-water", description: "محطة فرعية - المنطقة 6" },
            { id: "S7A", name: "المحطة الفرعية 7A", icon: "fa-tint", description: "محطة توزيع - المنطقة 7A" },
            { id: "S7B", name: "المحطة الفرعية 7B", icon: "fa-tint", description: "محطة توزيع - المنطقة 7B" },
            { id: "S8", name: "محطة المنطقة 8", icon: "fa-water", description: "محطة فرعية - المنطقة 8" },
            { id: "S9A", name: "المحطة الفرعية 9A", icon: "fa-tint", description: "محطة توزيع - المنطقة 9A" },
            { id: "S9B", name: "المحطة الفرعية 9B", icon: "fa-tint", description: "محطة توزيع - المنطقة 9B" },
            { id: "S9C", name: "المحطة الفرعية 9C", icon: "fa-tint", description: "محطة توزيع - المنطقة 9C" },
            { id: "S9D", name: "المحطة الفرعية 9D", icon: "fa-tint", description: "محطة توزيع - المنطقة 9D" },
            { id: "S9E", name: "المحطة الفرعية 9E", icon: "fa-tint", description: "محطة توزيع - المنطقة 9E" },
            { id: "S9F", name: "المحطة الفرعية 9F", icon: "fa-tint", description: "محطة توزيع - المنطقة 9F" }
        ];

        // ========== الدوال الأساسية ==========

        // إظهار شريط التحميل
        function showProgress() {
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('active');
        }

        // إخفاء شريط التحميل
        function hideProgress() {
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.remove('active');
        }

        // إظهار إشعار
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                type === 'warning' ? 'exclamation-triangle' : 
                                'times-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) reverse';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // تحديث حالة الاتصال
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.remove('offline');
                statusText.textContent = 'متصل بقاعدة البيانات السحابية';
                document.getElementById('syncState').textContent = 'متصل';
                isOnline = true;
            } else {
                statusDot.classList.add('offline');
                statusText.textContent = 'غير متصل - وضع عدم الاتصال';
                document.getElementById('syncState').textContent = 'غير متصل';
                isOnline = false;
            }
        }

        // ========== نظام Supabase ==========

        // تهيئة Supabase
        async function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // اختبار الاتصال
                const { data, error } = await supabase.from('stations').select('count').limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateConnectionStatus(true);
                showNotification('تم الاتصال بقاعدة البيانات السحابية', 'success');
                return true;
                
            } catch (error) {
                console.error('Supabase initialization error:', error);
                updateConnectionStatus(false);
                showNotification('تم التهيئة مع وضع عدم الاتصال', 'warning');
                return false;
            }
        }

        // حفظ البيانات إلى Supabase
        async function saveToSupabase(stationName, data) {
            if (!supabase || !isOnline) {
                console.log('Not connected to Supabase');
                return false;
            }
            
            showProgress();
            
            try {
                // التحقق من وجود المحطة
                const { data: existing } = await supabase
                    .from('stations')
                    .select('*')
                    .eq('station_id', stationName)
                    .single();
                
                if (existing) {
                    // تحديث البيانات
                    const { error } = await supabase
                        .from('stations')
                        .update({
                            station_data: data,
                            updated_at: new Date().toISOString(),
                            updated_by: data.operator
                        })
                        .eq('station_id', stationName);
                    
                    if (error) throw error;
                } else {
                    // إضافة جديدة
                    const { error } = await supabase
                        .from('stations')
                        .insert({
                            station_id: stationName,
                            station_name: data.station,
                            station_data: data,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            created_by: data.operator
                        });
                    
                    if (error) throw error;
                }
                
                hideProgress();
                return true;
                
            } catch (error) {
                console.error('Supabase save error:', error);
                hideProgress();
                return false;
            }
        }

        // تحميل البيانات من Supabase
        async function loadFromSupabase(stationName) {
            if (!supabase || !isOnline) {
                console.log('Not connected to Supabase');
                return null;
            }
            
            showProgress();
            
            try {
                const { data, error } = await supabase
                    .from('stations')
                    .select('*')
                    .eq('station_id', stationName)
                    .single();
                
                hideProgress();
                
                if (error) throw error;
                return data ? data.station_data : null;
                
            } catch (error) {
                console.error('Supabase load error:', error);
                hideProgress();
                return null;
            }
        }

        // تحميل قائمة المحطات من Supabase
        async function loadStationsFromSupabase() {
            if (!supabase || !isOnline) return;
            
            try {
                const { data, error } = await supabase
                    .from('stations')
                    .select('station_id, station_name, updated_at, updated_by')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                // تحديث حالة الكروت
                if (data) {
                    data.forEach(station => {
                        const statusEl = document.querySelector(`#status-${station.station_id}`);
                        if (statusEl) {
                            statusEl.classList.add('online');
                        }
                    });
                }
                
            } catch (error) {
                console.error('Error loading stations:', error);
            }
        }

        // ========== نظام الكروت ==========

        // إنشاء كروت المحطات
        function generateStationCards() {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';

            stationCards.forEach(station => {
                const card = document.createElement('div');
                card.className = 'station-card';
                card.dataset.id = station.id;
                
                card.innerHTML = `
                    <div class="station-status" id="status-${station.id}"></div>
                    <div class="station-icon">
                        <i class="fas ${station.icon}"></i>
                    </div>
                    <div class="station-id">${station.id}</div>
                    <div class="station-name">${station.name}</div>
                    <div class="station-desc">${station.description}</div>
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #888;">
                        <i class="fas fa-mouse-pointer"></i> انقر لفتح المحطة
                    </div>
                `;

                card.addEventListener('click', () => {
                    openStationForm(station.id);
                });

                cardsContainer.appendChild(card);
            });

            // تحميل حالة المحطات من السحابة
            loadStationsFromSupabase();
        }

        // فتح نموذج المحطة
        function openStationForm(stationId) {
            currentStation = stationId;
            
            // تحديث واجهة المحطة
            document.getElementById('stationTitle').innerHTML = `<i class="fas fa-water"></i> محطة ${stationId}`;
            document.getElementById('currentStation').textContent = stationId;
            document.getElementById('station-name').value = stationId;
            
            // التحويل إلى قسم النموذج
            document.getElementById('cardsSection').classList.remove('active');
            document.getElementById('formSection').classList.add('active');
            
            // توليد الجدول
            generateTable();
            
            // تحميل البيانات
            loadStationData();
            
            showNotification(`تم فتح محطة ${stationId}`, 'success');
        }

        // العودة إلى الكروت
        function backToCards() {
            document.getElementById('formSection').classList.remove('active');
            document.getElementById('cardsSection').classList.add('active');
            currentStation = '';
        }

        // ========== توليد الجدول ==========

        function generateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const sortedUnits = [...pumpUnits];
            sortedUnits.sort((a, b) => {
                if (a.name === "معلومات") return -1;
                if (b.name === "معلومات") return 1;
                if (a.unitNumber && b.unitNumber) {
                    return a.unitNumber - b.unitNumber;
                }
                return 0;
            });

            sortedUnits.forEach((unit) => {
                const unitHeaderRow = document.createElement("tr");
                const unitHeaderCell = document.createElement("td");
                unitHeaderCell.colSpan = 6;
                unitHeaderCell.textContent = unit.name;
                unitHeaderCell.className = "unit-header";
                unitHeaderRow.appendChild(unitHeaderCell);
                tableBody.appendChild(unitHeaderRow);

                unit.items.forEach((item) => {
                    const row = document.createElement("tr");

                    const nameCell = document.createElement("td");
                    nameCell.textContent = item.name;
                    row.appendChild(nameCell);

                    timeSlots.forEach((time, timeIndex) => {
                        const inputCell = document.createElement("td");
                        const input = document.createElement("input");

                        if (item.inputType === "number") {
                            input.type = "number";
                            input.inputMode = "decimal";
                            input.className = "data-input keyboard-number";
                            input.step = "0.01";
                        } else {
                            input.type = "text";
                            input.inputMode = "text";
                            input.className = "data-input keyboard-text";
                        }

                        input.placeholder = item.placeholder;
                        input.id = `${item.id}_${timeIndex}`;
                        input.setAttribute("data-unit", item.unit || "");
                        input.setAttribute("data-item-name", item.name);
                        input.setAttribute("data-time-slot", time);
                        input.setAttribute("autocomplete", "off");

                        inputCell.appendChild(input);
                        row.appendChild(inputCell);
                    });

                    tableBody.appendChild(row);
                });
            });
        }

        // ========== نظام الحفظ والتحميل ==========

        // تحميل بيانات المحطة
        async function loadStationData() {
            if (!currentStation) {
                showNotification('لم يتم تحديد محطة', 'warning');
                return;
            }
            
            showProgress();
            
            try {
                let data = null;
                
                // أولاً: حاول التحميل من Supabase
                if (isOnline) {
                    data = await loadFromSupabase(currentStation);
                }
                
                // ثانياً: إذا لم توجد على السحابة، جرب localStorage
                if (!data) {
                    data = loadFromLocalStorage(currentStation);
                }
                
                // ثالثاً: إذا لم توجد محلياً، جرب الكاش
                if (!data) {
                    data = stationDataCache[currentStation];
                }
                
                if (data) {
                    // تحديث الواجهة
                    document.getElementById('operator-name').value = data.operator || '';
                    document.getElementById('record-date').value = data.date || '';
                    document.getElementById('shift').value = data.shift || 'صباحية';
                    document.getElementById('currentOperator').textContent = data.operator || 'غير محدد';
                    
                    if (data.lastUpdated) {
                        const date = new Date(data.lastUpdated);
                        document.getElementById('lastUpdate').textContent = 
                            date.toLocaleDateString('ar-SA') + ' ' + 
                            date.toLocaleTimeString('ar-SA');
                    }
                    
                    // تحديث بيانات الجدول
                    if (data.inputs) {
                        Object.entries(data.inputs).forEach(([id, value]) => {
                            const el = document.getElementById(id);
                            if (el) el.value = value;
                        });
                    }
                    
                    // تحديث البيانات الإضافية
                    if (data.additional) {
                        document.getElementById('waterPath').value = data.additional.waterPath || '';
                        document.getElementById('tank1Level').value = data.additional.tank1 || '';
                        document.getElementById('tank2Level').value = data.additional.tank2 || '';
                        document.getElementById('tank3Level').value = data.additional.tank3 || '';
                        document.getElementById('compressor1').value = data.additional.comp1 || '';
                        document.getElementById('compressor2').value = data.additional.comp2 || '';
                        document.getElementById('com').value = data.additional.com || '';
                        document.getElementById('startTime').value = data.additional.start || '06:00';
                        document.getElementById('endTime').value = data.additional.end || '24:00';
                        document.getElementById('dailyNotes').value = data.additional.notes || '';
                    }
                    
                    // حفظ في الكاش
                    stationDataCache[currentStation] = data;
                    
                    calculateTotalHours();
                    
                    showNotification('تم تحميل بيانات المحطة', 'success');
                    
                } else {
                    document.getElementById('currentOperator').textContent = 'غير محدد';
                    document.getElementById('lastUpdate').textContent = 'غير متوفر';
                    showNotification('لا توجد بيانات سابقة، ابدأ بإدخال بيانات جديدة', 'info');
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('خطأ في تحميل البيانات', 'error');
            } finally {
                hideProgress();
            }
        }

        // حفظ بيانات المحطة
        async function saveStationData() {
            const stationName = document.getElementById('station-name').value.trim();
            const operator = document.getElementById('operator-name').value.trim();
            
            if (!stationName) {
                showNotification('يرجى إدخال اسم المحطة', 'warning');
                return;
            }
            
            if (!operator) {
                showNotification('يرجى إدخال اسم المشغل', 'warning');
                return;
            }
            
            if (!confirm(`هل تريد حفظ بيانات محطة ${stationName}؟`)) {
                return;
            }
            
            showProgress();
            
            try {
                // جمع البيانات
                const data = {
                    station: stationName,
                    operator: operator,
                    date: document.getElementById('record-date').value,
                    shift: document.getElementById('shift').value,
                    inputs: {},
                    additional: {
                        waterPath: document.getElementById('waterPath').value,
                        tank1: document.getElementById('tank1Level').value,
                        tank2: document.getElementById('tank2Level').value,
                        tank3: document.getElementById('tank3Level').value,
                        comp1: document.getElementById('compressor1').value,
                        comp2: document.getElementById('compressor2').value,
                        com: document.getElementById('com').value,
                        start: document.getElementById('startTime').value,
                        end: document.getElementById('endTime').value,
                        notes: document.getElementById('dailyNotes').value
                    },
                    lastUpdated: new Date().toISOString(),
                    lastOperator: operator,
                    lastShift: document.getElementById('shift').value
                };
                
                // جمع بيانات الجدول
                document.querySelectorAll('.data-input').forEach(input => {
                    if (input.value) {
                        data.inputs[input.id] = input.value;
                    }
                });
                
                // حفظ في Supabase (إذا كان متصلاً)
                let savedToCloud = false;
                if (isOnline) {
                    savedToCloud = await saveToSupabase(stationName, data);
                }
                
                // حفظ في localStorage (نسخة احتياطية)
                saveToLocalStorage(stationName, data);
                
                // حفظ في الكاش
                stationDataCache[stationName] = data;
                
                // تحديث الواجهة
                document.getElementById('currentStation').textContent = stationName;
                document.getElementById('currentOperator').textContent = operator;
                document.getElementById('lastUpdate').textContent = 'الآن';
                
                if (savedToCloud) {
                    showNotification('تم حفظ البيانات على السحابة بنجاح', 'success');
                } else {
                    showNotification('تم حفظ البيانات محلياً', 'warning');
                }
                
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('خطأ في حفظ البيانات', 'error');
            } finally {
                hideProgress();
            }
        }

        // مزامنة البيانات
        async function syncData() {
            showProgress();
            
            try {
                // تحميل جميع المحطات من السحابة
                if (isOnline && supabase) {
                    const { data: cloudStations, error } = await supabase
                        .from('stations')
                        .select('*');
                    
                    if (error) throw error;
                    
                    if (cloudStations) {
                        cloudStations.forEach(station => {
                            stationDataCache[station.station_id] = station.station_data;
                            saveToLocalStorage(station.station_id, station.station_data);
                        });
                        
                        showNotification(`تم مزامنة ${cloudStations.length} محطة`, 'success');
                    }
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('خطأ في المزامنة', 'error');
            } finally {
                hideProgress();
            }
        }

        // ========== نظام localStorage ==========

        function saveToLocalStorage(stationName, data) {
            try {
                localStorage.setItem(`station_${stationName}`, JSON.stringify(data));
                localStorage.setItem('last_station', stationName);
            } catch (e) {
                console.error("Local storage save error:", e);
            }
        }

        function loadFromLocalStorage(stationName) {
            try {
                const saved = localStorage.getItem(`station_${stationName}`);
                return saved ? JSON.parse(saved) : null;
            } catch (e) {
                console.error("Local storage load error:", e);
                return null;
            }
        }

        // ========== الميزات الإضافية ==========

        function calculateTotalHours() {
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;

            if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);

                if (end < start) {
                    end.setDate(end.getDate() + 1);
                }

                const diffMs = end - start;
                const diffHours = diffMs / (1000 * 60 * 60);

                document.getElementById("totalHours").value = diffHours.toFixed(2);
            }
        }

        function addNewUnit() {
            let maxUnitNumber = 2;
            pumpUnits.forEach(unit => {
                if (unit.type === "unit" && unit.unitNumber > maxUnitNumber) {
                    maxUnitNumber = unit.unitNumber;
                }
            });

            const nextUnitNumber = maxUnitNumber + 1;

            if (nextUnitNumber > 9) {
                alert("الحد الأقصى للوحدات هو 9 وحدات");
                return;
            }

            const newUnit = {
                name: `الوحدة رقم ${nextUnitNumber}`,
                type: "unit",
                unitNumber: nextUnitNumber,
                items: [
                    { name: "إجمالي عدد الساعات", id: `totalHours${nextUnitNumber}`, unit: "ساعة", inputType: "number", placeholder: "أدخل عدد الساعات" },
                    { name: "فتحة محبس الطرد (%)", id: `valve${nextUnitNumber}`, unit: "%", inputType: "number", placeholder: "أدخل النسبة المئوية" },
                    { name: "ضغط سحب المضخة", id: `suction${nextUnitNumber}`, unit: "بار", inputType: "number", placeholder: "أدخل الضغط بالبار" },
                    { name: "ضغط طرد المضخة", id: `discharge${nextUnitNumber}`, unit: "بار", inputType: "number", placeholder: "أدخل الضغط بالبار" },
                    { name: "حالة حرارة كرسي التحميل", id: `bearing${nextUnitNumber}`, unit: "°C", inputType: "mixed", placeholder: "أدخل الحرارة أو الحالة" },
                    { name: "حالة الحشو", id: `seal${nextUnitNumber}`, unit: "", inputType: "text", placeholder: "أدخل حالة الحشو" },
                    { name: "درجة حرارة الموتور", id: `motorTemp${nextUnitNumber}`, unit: "", inputType: "mixed", placeholder: "أدخل درجة الحرارة أو الحالة" },
                    { name: "شدة تيار الموتور", id: `motorCurrent${nextUnitNumber}`, unit: "أمبير", inputType: "number", placeholder: "أدخل شدة التيار" }
                ]
            };

            pumpUnits.push(newUnit);
            generateTable();
            showNotification('تم إضافة وحدة جديدة', 'success');
        }

        function resetForm() {
            if (confirm("هل تريد إعادة تعيين جميع البيانات؟")) {
                document.getElementById('operator-name').value = '';
                document.getElementById('record-date').valueAsDate = new Date();
                document.getElementById('shift').value = 'صباحية';
                document.getElementById('waterPath').value = '';
                document.getElementById('tank1Level').value = '';
                document.getElementById('tank2Level').value = '';
                document.getElementById('tank3Level').value = '';
                document.getElementById('compressor1').value = '';
                document.getElementById('compressor2').value = '';
                document.getElementById('com').value = '';
                document.getElementById('startTime').value = '06:00';
                document.getElementById('endTime').value = '24:00';
                document.getElementById('dailyNotes').value = '';
                
                document.querySelectorAll('.data-input').forEach(input => {
                    input.value = '';
                });
                
                calculateTotalHours();
                showNotification('تم إعادة تعيين النموذج', 'info');
            }
        }

        function exportToExcel() {
            const stationName = document.getElementById('station-name').value || 'محطة';
            
            if (!stationName) {
                showNotification('يرجى إدخال اسم المحطة', 'warning');
                return;
            }
            
            const wsData = [];
            wsData.push([`سجل محطة ضخ - ${stationName}`]);
            wsData.push([]);
            wsData.push(["اسم المحطة", document.getElementById("station-name").value]);
            wsData.push(["اسم المشغل", document.getElementById("operator-name").value]);
            wsData.push(["التاريخ", document.getElementById("record-date").value]);
            wsData.push(["الوردية", document.getElementById("shift").value]);
            wsData.push([]);
            wsData.push(["بيانات الوحدات"]);
            wsData.push([]);

            const tableHeaders = ["البيان", "6:00 ص", "11:00 ص", "4:00 م", "9:00 م", "2:00 ص"];
            wsData.push(tableHeaders);

            const rows = document.querySelectorAll("#pumpTable tbody tr");
            rows.forEach(row => {
                if (row.querySelector('.unit-header')) return;

                const rowData = [];
                const cells = row.querySelectorAll("td");
                cells.forEach((cell, index) => {
                    if (index === 0) {
                        rowData.push(cell.textContent);
                    } else if (index <= 5) {
                        const input = cell.querySelector("input");
                        rowData.push(input ? input.value : "");
                    }
                });
                if (rowData.length > 0) {
                    wsData.push(rowData);
                }
            });

            wsData.push([]);
            wsData.push(["بيانات إضافية"]);
            wsData.push([]);

            const additionalData = [
                ["الطرق المائي", document.getElementById("waterPath").value],
                ["مستوي المياه بالخزان الأول", document.getElementById("tank1Level").value],
                ["مستوي المياه بالخزان الثاني", document.getElementById("tank2Level").value],
                ["مستوي المياه بالخزان الثالث", document.getElementById("tank3Level").value],
                ["مستوي الزيت بالضاغط الأول", document.getElementById("compressor1").value],
                ["مستوي الزيت بالضاغط الثاني", document.getElementById("compressor2").value],
                ["مستوي الزيت بالضاغط", document.getElementById("com").value],
                ["توقيت تشغيل المحطة", document.getElementById("startTime").value],
                ["توقيت إيقاف المحطة", document.getElementById("endTime").value],
                ["عدد ساعات التشغيل", document.getElementById("totalHours").value],
                ["ملاحظات اليوم", document.getElementById("dailyNotes").value]
            ];

            additionalData.forEach(item => {
                wsData.push(item);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            XLSX.utils.book_append_sheet(wb, ws, `محطة ${stationName}`);

            const date = document.getElementById("record-date").value || new Date().toISOString().split("T")[0];
            const fileName = `${stationName}_${date}.xlsx`;

            XLSX.writeFile(wb, fileName);
            showNotification("تم تصدير البيانات إلى ملف Excel", "success");
        }

        // ========== إعداد الأحداث ==========

        function setupEventListeners() {
            document.getElementById('backBtn').addEventListener('click', backToCards);
            
            document.getElementById('newStationBtn').addEventListener('click', () => {
                currentStation = '';
                document.getElementById('stationTitle').innerHTML = '<i class="fas fa-water"></i> محطة جديدة';
                document.getElementById('currentStation').textContent = 'جديد';
                document.getElementById('currentOperator').textContent = 'غير محدد';
                document.getElementById('lastUpdate').textContent = 'غير متوفر';
                document.getElementById('station-name').value = '';
                document.getElementById('operator-name').value = '';
                
                document.getElementById('cardsSection').classList.remove('active');
                document.getElementById('formSection').classList.add('active');
                
                generateTable();
                resetForm();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', () => {
                generateStationCards();
                showNotification('تم تحديث قائمة المحطات', 'success');
            });
            
            document.getElementById('saveBtn').addEventListener('click', saveStationData);
            document.getElementById('syncBtn').addEventListener('click', syncData);
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('addRowBtn').addEventListener('click', addNewUnit);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            document.getElementById("startTime").addEventListener("change", calculateTotalHours);
            document.getElementById("endTime").addEventListener("change", calculateTotalHours);
            
            document.getElementById('station-name').addEventListener('change', function() {
                document.getElementById('currentStation').textContent = this.value || 'غير محدد';
                if (this.value) {
                    document.getElementById('stationTitle').innerHTML = `<i class="fas fa-water"></i> محطة ${this.value}`;
                }
            });
        }

        // ========== تهيئة التطبيق ==========

        async function initializeApp() {
            // تعيين التاريخ الحالي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
            
            // توليد الكروت
            generateStationCards();
            
            // إعداد الأحداث
            setupEventListeners();
            
            // تهيئة Supabase
            await initializeSupabase();
            
            // حساب الساعات الافتراضية
            calculateTotalHours();
            
            // تحميل آخر محطة
            const lastStation = localStorage.getItem('last_station');
            if (lastStation) {
                document.getElementById('station-name').value = lastStation;
                document.getElementById('currentStation').textContent = lastStation;
            }
        }

        // تشغيل التطبيق
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
