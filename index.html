<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>نظام إدارة محطات الضخ - مزامنة لحظية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            direction: rtl;
            min-height: 100vh;
        }
        
        /* ========== الهيدر الرئيسي ========== */
        .main-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1d3d75 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        .title-section h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .title-section p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .user-shift-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            .user-shift-section {
                flex-direction: row;
                align-items: center;
                gap: 20px;
            }
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .user-info input {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            width: 100%;
            min-width: 200px;
        }
        
        .shift-controls {
            display: flex;
            gap: 10px;
        }
        
        .shift-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
        }
        
        .shift-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .shift-btn.active {
            background: white;
            color: #2c5aa0;
            border-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* ========== شريط الحالة ========== */
        .status-bar {
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .status-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .sync-status.online {
            color: #28a745;
        }
        
        .sync-status.offline {
            color: #dc3545;
        }
        
        .current-shift-display {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.9; }
            100% { opacity: 1; }
        }
        
        /* ========== محتوى الصفحة ========== */
        .page-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 1024px) {
            .page-content {
                grid-template-columns: 350px 1fr;
            }
        }
        
        /* ========== قسم البطاقات ========== */
        .stations-sidebar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: fit-content;
            position: sticky;
            top: 120px;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .sidebar-header h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .stations-grid {
            padding: 15px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        /* ========== بطاقات المحطات ========== */
        .station-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }
        
        .station-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-color: #2c5aa0;
        }
        
        .station-card.active {
            border-color: #2c5aa0;
            background: linear-gradient(135deg, #f0f7ff, #e6f0ff);
            box-shadow: 0 8px 20px rgba(44, 90, 160, 0.2);
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #2c5aa0;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .station-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .station-info h4 {
            font-size: 1.1rem;
            margin-bottom: 3px;
            color: #2c5aa0;
        }
        
        .station-info p {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #e0e0e0;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 3px;
        }
        
        .stat-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .last-update {
            font-size: 0.8rem;
            color: #28a745;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ========== قسم النموذج ========== */
        .form-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 80vh;
        }
        
        .form-header {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .selected-station-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .station-number-large {
            background: white;
            color: #2c5aa0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .form-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .current-editor-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ========== النموذج الأصلي ========== */
        .form-content {
            padding: 25px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .header-name {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .header-name {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .info-item label {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .info-item input,
        .info-item select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .info-item input:focus,
        .info-item select:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
            outline: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 10px;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            min-width: 160px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(44, 90, 160, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 15px 10px;
            text-align: center;
            font-size: 14px;
        }
        
        th {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            font-size: 13px;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #f0f7ff;
        }
        
        .unit-header {
            background-color: #eef5ff !important;
            font-weight: bold;
            color: #1d3d75;
            font-size: 15px;
        }
        
        .data-input {
            width: 100%;
            padding: 12px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .data-input:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
            outline: none;
        }
        
        .time-slots {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(135deg, #eef5ff, #e6f0ff);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .time-slot {
            font-weight: bold;
            color: #2c5aa0;
            font-size: 13px;
            text-align: center;
            flex: 1;
            min-width: 60px;
            padding: 8px 5px;
            background: white;
            border-radius: 6px;
            border: 1px solid #d0e0ff;
        }
        
        .footer-section {
            margin-top: 25px;
            padding: 25px;
            background-color: #f8fafc;
            border-radius: 10px;
            border: 2px solid #eef5ff;
        }
        
        .footer-row {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .footer-row {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        .footer-col,
        .footer-col1 {
            flex: 1;
            min-width: 200px;
        }
        
        .footer-col label,
        .footer-col1 label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #1d3d75;
            font-size: 1rem;
        }
        
        .notes {
            margin-top: 25px;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            height: 120px;
            resize: vertical;
            transition: all 0.3s;
        }
        
        textarea:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
            outline: none;
        }
        
        .section-title,
        .section-to,
        .section-tox {
            background: linear-gradient(135deg, #2c5aa0, #1d3d75);
            color: white;
            padding: 18px;
            margin: 30px 0 20px 0;
            border-radius: 10px;
            font-size: 17px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        /* ========== إشعارات ========== */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease-out;
            border-left: 5px solid #2c5aa0;
            max-width: 350px;
            min-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            border-left-color: #28a745;
        }
        
        .notification.warning {
            border-left-color: #ffc107;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification-icon {
            font-size: 1.8rem;
        }
        
        /* ========== مؤشر التحميل ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            gap: 20px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ========== الفوتر ========== */
        .main-footer {
            background: linear-gradient(135deg, #1d3d75, #2c5aa0);
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 40px;
        }
        
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* ========== وسائط متعددة ========== */
        @media (max-width: 768px) {
            .page-content {
                padding: 15px;
            }
            
            .stations-sidebar {
                position: static;
                margin-bottom: 20px;
            }
            
            .form-header {
                padding: 20px 15px;
            }
            
            .form-content {
                padding: 15px;
            }
            
            .btn {
                padding: 12px 20px;
                min-width: 140px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .header-content {
                text-align: center;
            }
            
            .shift-controls {
                justify-content: center;
            }
            
            .status-content {
                justify-content: center;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* ========== تحسينات خاصة ========== */
        .highlight-update {
            animation: highlight 2s ease-out;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(40, 167, 69, 0.3); }
            100% { background-color: transparent; }
        }
        
        .field-with-update {
            position: relative;
        }
        
        .update-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <!-- مؤشر التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="font-size: 1.1rem; color: #2c5aa0; font-weight: bold;">
            جاري تحميل النظام...
        </div>
    </div>

    <!-- الهيدر الرئيسي -->
    <header class="main-header">
        <div class="header-content">
            <div class="title-section">
                <h1>
                    <i class="fas fa-water"></i>
                    نظام إدارة محطات الضخ المتكامل
                </h1>
                <p>مزامنة لحظية بين المشغلين - تحديث فوري للبيانات</p>
            </div>
            
            <div class="user-shift-section">
                <div class="user-info">
                    <input type="text" id="userName" placeholder="اسم المشغل ثلاثي" />
                    <input type="text" id="userId" placeholder="الرقم التعريفي" />
                </div>
                
                <div class="shift-controls">
                    <button class="shift-btn active" id="dayShiftBtn">
                        <i class="fas fa-sun"></i>
                        نهارية
                    </button>
                    <button class="shift-btn" id="nightShiftBtn">
                        <i class="fas fa-moon"></i>
                        ليلية
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- شريط الحالة -->
    <div class="status-bar">
        <div class="status-content">
            <div class="sync-status online" id="syncStatus">
                <i class="fas fa-wifi"></i>
                <span>متصل بالسحابة - تحديث لحظي</span>
            </div>
            
            <div id="currentShiftDisplay" class="current-shift-display">
                <i class="fas fa-sun"></i>
                <span>الوردية النهارية</span>
            </div>
            
            <div style="color: #666; font-size: 0.9rem;">
                <i class="far fa-clock"></i>
                <span id="lastUpdateTime">آخر تحديث: الآن</span>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="page-content">
        <!-- القسم الجانبي للبطاقات -->
        <div class="stations-sidebar">
            <div class="sidebar-header">
                <h3>
                    <i class="fas fa-map-marker-alt"></i>
                    محطات المنطقة S
                </h3>
                <p>22 محطة - اختر محطة للتحرير</p>
            </div>
            
            <div class="stations-grid" id="stationsGrid">
                <!-- سيتم إضافة البطاقات ديناميكياً -->
            </div>
        </div>

        <!-- قسم النموذج -->
        <div class="form-container" id="formContainer">
            <div class="form-header" id="formHeader">
                <div class="selected-station-info">
                    <div class="station-number-large" id="selectedStationNumber">1</div>
                    <div>
                        <h2 id="selectedStationName">اختر محطة للبدء</h2>
                        <p style="opacity: 0.9; font-size: 0.95rem;">
                            <i class="far fa-clock"></i>
                            <span id="selectedStationUpdate">لم يتم تحديثه بعد</span>
                        </p>
                    </div>
                </div>
                
                <div id="currentEditorInfo" class="current-editor-info" style="display: none;">
                    <i class="fas fa-user-edit"></i>
                    <span>قيد التحرير بواسطة: <strong id="editorName">غير معروف</strong></span>
                </div>
            </div>

            <!-- النموذج الأصلي -->
            <div class="form-content" id="originalForm">
                <div class="header-info">
                    <div class="info-item">
                        <label for="station-name">اسم المحطة:</label>
                        <input type="text" id="station-name" class="keyboard-text" 
                               placeholder="سيتم تعبئته تلقائياً" readonly />
                    </div>
                    <div class="header-name">
                        <div class="info-item">
                            <label for="operator-name">اسم المشغل:</label>
                            <input type="text" id="operator-name" class="keyboard-text" 
                                   placeholder="سيتم تعبئته تلقائياً" readonly />
                        </div>

                        <div class="info-item">
                            <label for="record-date">التاريخ:</label>
                            <input type="date" id="record-date" />
                        </div>

                        <div class="info-item">
                            <label for="shift">الوردية:</label>
                            <select id="shift">
                                <option value="صباحية">صباحية</option>
                                <option value="مسائية">مسائية</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" id="saveBtn">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                        <button class="btn btn-success" id="exportBtn">
                            <i class="fas fa-file-excel"></i> تصدير Excel
                        </button>
                        <button class="btn btn-secondary" id="printBtn">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        <button class="btn btn-secondary" id="unlockBtn" style="display: none;">
                            <i class="fas fa-unlock"></i> إلغاء القفل
                        </button>
                    </div>
                </div>

                <div class="time-slots">
                    <div class="time-slot">6:00 ص</div>
                    <div class="time-slot">11:00 ص</div>
                    <div class="time-slot">4:00 م</div>
                    <div class="time-slot">9:00 م</div>
                    <div class="time-slot">2:00 ص</div>
                </div>

                <div class="table-container">
                    <table id="pumpTable">
                        <thead>
                            <tr>
                                <th rowspan="2">البيان</th>
                                <th colspan="5">القراءات حسب الوقت</th>
                            </tr>

                            <tr>
                                <th>6:00 ص</th>
                                <th>11:00 ص</th>
                                <th>4:00 م</th>
                                <th>9:00 م</th>
                                <th>2:00 ص</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- البيانات سيتم إضافتها بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="section-title">
                    <i class="fas fa-tachometer-alt"></i> منظومة الطرق المائي و ضاغط الهواء
                </div>

                <div class="footer-section">
                    <div class="footer-row">
                        <div class="footer-col">
                            <label>الطرق المائي:</label>
                            <input type="text" id="waterPath" class="keyboard-text" 
                                   placeholder="حالة الطرق المائي" />
                        </div>

                        <div class="footer-col">
                            <label>مستوي المياه بالخزان الأول:</label>
                            <input type="text" id="tank1Level" class="keyboard-text" 
                                   placeholder="المستوي (ممتلئ/متوسط/منخفض)" />
                        </div>

                        <div class="footer-col">
                            <label>مستوي المياه بالخزان الثاني:</label>
                            <input type="text" id="tank2Level" class="keyboard-text" 
                                   placeholder="المستوي (ممتلئ/متوسط/منخفض)" />
                        </div>
                    </div>

                    <div class="footer-row">
                        <div class="footer-col">
                            <label>مستوي المياه بالخزان الثالث:</label>
                            <input type="text" id="tank3Level" class="keyboard-text" 
                                   placeholder="المستوي (ممتلئ/متوسط/منخفض)" />
                        </div>

                        <div class="footer-col">
                            <label>مستوي الزيت بالضاغط الأول / درجة الحرارة:</label>
                            <input type="text" id="compressor1" class="keyboard-text" 
                                   placeholder="مثال: جيد / 45°C" />
                        </div>

                        <div class="footer-col">
                            <label>مستوي الزيت بالضاغط الثاني / درجة الحرارة:</label>
                            <input type="text" id="compressor2" class="keyboard-text" 
                                   placeholder="مثال: جيد / 42°C" />
                        </div>
                    </div>

                    <div class="section-to">
                        <i class="fas fa-tachometer-alt"></i> منظومة التحضير
                    </div>

                    <div class="footer-col1">
                        <label>مستوي الزيت بالضاغط / درجة الحرارة:</label>
                        <input type="text" id="com" class="keyboard-text" 
                               placeholder="مستوي زيت / درجة حرارة" />
                    </div>

                    <div class="section-tox">
                        <i class="fas fa-tachometer-alt"></i> مواعيد التشغيل \ الإيقاف للمحطة
                    </div>

                    <div class="footer-row">
                        <div class="footer-col">
                            <label>توقيت تشغيل المحطة:</label>
                            <input type="time" id="startTime" value="06:00" />
                        </div>

                        <div class="footer-col">
                            <label>توقيت إيقاف المحطة:</label>
                            <input type="time" id="endTime" value="24:00" />
                        </div>

                        <div class="footer-col">
                            <label>عدد ساعات تشغيل المحطة خلال اليوم:</label>
                            <input type="text" id="totalHours" class="keyboard-number" 
                                   placeholder="عدد الساعات" />
                        </div>
                    </div>

                    <div class="notes">
                        <label for="dailyNotes">ملاحظات اليوم:</label>
                        <textarea id="dailyNotes" class="keyboard-text" 
                                  placeholder="أدخل أي ملاحظات هامة عن تشغيل المحطة اليوم..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الفوتر -->
    <footer class="main-footer">
        <div class="footer-content">
            <p>نظام إدارة محطات الضخ - النسخة المتكاملة 2025</p>
            <p style="opacity: 0.8; font-size: 0.9rem; margin-top: 5px;">
                جميع البيانات متزامنة لحظياً بين جميع المستخدمين
            </p>
        </div>
    </footer>

    <!-- منطقة الإشعارات -->
    <div id="notifications-container"></div>

    <!-- مكتبات Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ========== تكوين Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCKbEAIcSnw70CqUflBVFuv7KUq1VMjgTA",
            authDomain: "pump-station-system.firebaseapp.com",
            projectId: "pump-station-system",
            databaseURL: "https://pump-station-system-default-rtdb.firebaseio.com",
            storageBucket: "pump-station-system.firebasestorage.app",
            messagingSenderId: "734880960614",
            appId: "1:734880960614:web:79039329fcfe3888181da7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========== المتغيرات العامة ==========
        let currentUser = {
            name: '',
            id: '',
            shift: 'day'
        };

        let currentStation = null;
        let allStations = [];
        let pumpUnits = [];
        let stationListeners = {};

        // ========== توليد 22 محطة ==========
        function generateStations() {
            const stations = [];
            const stationNames = [
                "محطة الضخ S1", "محطة الضخ S2", "محطة الضخ S3", "محطة الضخ S4", 
                "محطة الضخ S5", "محطة الضخ S6", "محطة الضخ S7", "محطة الضخ S8",
                "محطة الضخ S9", "محطة الضخ S10", "محطة الضخ S11", "محطة الضخ S12",
                "محطة الضخ S13", "محطة الضخ S14", "محطة الضخ S15", "محطة الضخ S16",
                "محطة الضخ S17", "محطة الضخ S18", "محطة الضخ S19", "محطة الضخ S20",
                "محطة الضخ S21", "محطة الضخ S22"
            ];

            for (let i = 0; i < 22; i++) {
                stations.push({
                    id: `station_${i + 1}`,
                    name: stationNames[i],
                    number: i + 1,
                    // بيانات مشتركة بين الورديتين
                    data: {
                        operator: '',
                        lastUpdated: null,
                        updatedBy: '',
                        updatedByShift: '',
                        readings: {},
                        additional: {},
                        dailyNotes: ''
                    },
                    lockedBy: null,
                    lockTime: null
                });
            }

            return stations;
        }

        // ========== عرض الإشعارات ==========
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications-container');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            notification.innerHTML = `
                <div class="notification-icon" style="color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#2c5aa0'}">
                    <i class="fas ${icon}"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.05rem;">
                        ${type === 'success' ? 'نجاح' : type === 'error' ? 'خطأ' : type === 'warning' ? 'تنبيه' : 'معلومة'}
                    </div>
                    <div>${message}</div>
                </div>
                <div style="cursor: pointer; padding: 5px;" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ========== تحديث عرض الوردية ==========
        function updateShiftDisplay() {
            const display = document.getElementById('currentShiftDisplay');
            const shiftName = currentUser.shift === 'day' ? 'النهارية' : 'الليلية';
            const icon = currentUser.shift === 'day' ? 'fa-sun' : 'fa-moon';
            
            display.innerHTML = `<i class="fas ${icon}"></i><span>الوردية ${shiftName}</span>`;
            
            // تحديث أزرار الوردية
            document.getElementById('dayShiftBtn').classList.toggle('active', currentUser.shift === 'day');
            document.getElementById('nightShiftBtn').classList.toggle('active', currentUser.shift === 'night');
            
            // تحديث حقل الوردية في النموذج
            document.getElementById('shift').value = currentUser.shift === 'day' ? 'صباحية' : 'مسائية';
        }

        // ========== تبديل الوردية ==========
        function switchShift(newShift) {
            if (!currentUser.name || !currentUser.id) {
                showNotification('يجب إدخال اسم المشغل والرقم التعريفي أولاً', 'warning');
                return;
            }
            
            currentUser.shift = newShift;
            localStorage.setItem('current_shift', newShift);
            updateShiftDisplay();
            
            // إذا كان هناك محطة محملة، نقوم بتحديث البيانات
            if (currentStation) {
                loadStationData(currentStation.id);
            }
            
            showNotification(`تم التبديل إلى الوردية ${newShift === 'day' ? 'النهارية' : 'الليلية'}`, 'success');
        }

        // ========== إنشاء بطاقات المحطات ==========
        function createStationCards() {
            const grid = document.getElementById('stationsGrid');
            grid.innerHTML = '';

            allStations.forEach(station => {
                const card = document.createElement('div');
                card.className = 'station-card';
                card.dataset.stationId = station.id;
                
                // تاريخ آخر تحديث
                let lastUpdateText = 'لم يتم تحديثه';
                let lastUpdateTime = '';
                if (station.data.lastUpdated) {
                    const date = new Date(station.data.lastUpdated);
                    lastUpdateText = `تم التحديث ${date.toLocaleDateString('ar-EG')}`;
                    lastUpdateTime = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                }

                card.innerHTML = `
                    <div class="card-badge">${station.number}</div>
                    <div class="card-header">
                        <div class="station-icon">
                            <i class="fas fa-water-pump"></i>
                        </div>
                        <div class="station-info">
                            <h4>${station.name}</h4>
                            <p>
                                <i class="fas fa-user"></i>
                                <span>${station.data.operator || 'لا يوجد مشغل'}</span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="card-stats">
                        <div class="stat-item">
                            <div class="stat-label">الحالة</div>
                            <div class="stat-value">${station.data.additional.status || 'غير معروفة'}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">الضغط</div>
                            <div class="stat-value">${station.data.readings.pressure || '0'} بار</div>
                        </div>
                    </div>
                    
                    ${station.data.lastUpdated ? `
                        <div class="last-update">
                            <i class="fas fa-history"></i>
                            <span>${lastUpdateTime} - ${station.data.updatedBy || 'غير معروف'}</span>
                        </div>
                    ` : ''}
                    
                    ${station.lockedBy ? `
                        <div style="margin-top: 8px; padding: 5px 10px; background: #ffebee; border-radius: 5px; font-size: 0.8rem; color: #d32f2f;">
                            <i class="fas fa-lock"></i>
                            قيد التحرير
                        </div>
                    ` : ''}
                `;

                card.addEventListener('click', () => {
                    // إزالة التحديد من جميع البطاقات
                    document.querySelectorAll('.station-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    
                    // تحديد البطاقة المختارة
                    card.classList.add('active');
                    
                    // تحميل المحطة في النموذج
                    loadStationIntoForm(station.id);
                });

                grid.appendChild(card);
            });
        }

        // ========== تحميل محطة في النموذج ==========
        async function loadStationIntoForm(stationId) {
            try {
                document.getElementById('loadingOverlay').style.display = 'flex';
                
                const station = allStations.find(s => s.id === stationId);
                if (!station) return;

                currentStation = station;

                // تحديث الهيدر
                document.getElementById('selectedStationNumber').textContent = station.number;
                document.getElementById('selectedStationName').textContent = station.name;
                
                if (station.data.lastUpdated) {
                    const date = new Date(station.data.lastUpdated);
                    const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    const dateStr = date.toLocaleDateString('ar-EG');
                    document.getElementById('selectedStationUpdate').textContent = 
                        `آخر تحديث: ${timeStr} ${dateStr} بواسطة ${station.data.updatedBy || 'غير معروف'}`;
                } else {
                    document.getElementById('selectedStationUpdate').textContent = 'لم يتم تحديثه بعد';
                }

                // عرض معلومات المحرر الحالي
                if (station.lockedBy) {
                    document.getElementById('currentEditorInfo').style.display = 'flex';
                    document.getElementById('editorName').textContent = station.lockedBy.split('|')[0];
                    document.getElementById('unlockBtn').style.display = 'flex';
                } else {
                    document.getElementById('currentEditorInfo').style.display = 'none';
                    document.getElementById('unlockBtn').style.display = 'none';
                }

                // تعبئة بيانات النموذج
                document.getElementById('station-name').value = station.name;
                document.getElementById('operator-name').value = station.data.operator || '';
                document.getElementById('dailyNotes').value = station.data.dailyNotes || '';

                // تعبئة البيانات الإضافية
                if (station.data.additional) {
                    document.getElementById('waterPath').value = station.data.additional.waterPath || '';
                    document.getElementById('tank1Level').value = station.data.additional.tank1Level || '';
                    document.getElementById('tank2Level').value = station.data.additional.tank2Level || '';
                    document.getElementById('tank3Level').value = station.data.additional.tank3Level || '';
                    document.getElementById('compressor1').value = station.data.additional.compressor1 || '';
                    document.getElementById('compressor2').value = station.data.additional.compressor2 || '';
                    document.getElementById('com').value = station.data.additional.compressor || '';
                    document.getElementById('startTime').value = station.data.additional.startTime || '06:00';
                    document.getElementById('endTime').value = station.data.additional.endTime || '24:00';
                    document.getElementById('totalHours').value = station.data.additional.totalHours || '';
                }

                // تعبئة قراءات الجدول
                if (station.data.readings) {
                    setTimeout(() => {
                        fillTableReadings(station.data.readings);
                    }, 100);
                }

                // تسجيل دخول المستخدم
                await registerUserToStation(stationId);

                showNotification(`تم تحميل بيانات ${station.name}`, 'success');

            } catch (error) {
                showNotification('حدث خطأ أثناء تحميل البيانات', 'error');
                console.error('Error loading station:', error);
            } finally {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
            }
        }

        // ========== تعبئة قراءات الجدول ==========
        function fillTableReadings(readings) {
            document.querySelectorAll('.data-input').forEach(input => {
                const id = input.id;
                if (readings[id]) {
                    input.value = readings[id];
                }
            });
        }

        // ========== تسجيل دخول المستخدم للمحطة ==========
        async function registerUserToStation(stationId) {
            if (!currentUser.name || !currentUser.id) {
                showNotification('يجب إدخال بيانات المستخدم أولاً', 'warning');
                return false;
            }

            const station = allStations.find(s => s.id === stationId);
            if (!station) return false;

            // إذا كانت المحطة مقفلة بواسطة مستخدم آخر
            if (station.lockedBy && station.lockedBy !== `${currentUser.name}|${currentUser.id}`) {
                showNotification('هذه المحطة قيد التحرير بواسطة مشغل آخر', 'warning');
                return false;
            }

            // قفل المحطة للمستخدم الحالي
            station.lockedBy = `${currentUser.name}|${currentUser.id}`;
            station.lockTime = new Date().toISOString();

            try {
                await database.ref(`stations/${stationId}`).update({
                    lockedBy: station.lockedBy,
                    lockTime: station.lockTime
                });

                // تحديث الواجهة
                document.getElementById('currentEditorInfo').style.display = 'flex';
                document.getElementById('editorName').textContent = currentUser.name;
                document.getElementById('unlockBtn').style.display = 'flex';

                // تحديث البطاقات
                createStationCards();

                return true;
            } catch (error) {
                console.error('Error locking station:', error);
                return false;
            }
        }

        // ========== حفظ بيانات المحطة ==========
        async function saveStationData() {
            if (!currentStation || !currentUser.name || !currentUser.id) {
                showNotification('يجب تحديد محطة وإدخال بيانات المستخدم', 'warning');
                return;
            }

            // تأكيد أن المحطة مقفلة بواسطة المستخدم الحالي
            if (currentStation.lockedBy !== `${currentUser.name}|${currentUser.id}`) {
                showNotification('يجب قفل المحطة للتحرير أولاً', 'error');
                return;
            }

            try {
                document.getElementById('loadingOverlay').style.display = 'flex';

                // جمع بيانات النموذج
                const stationData = {
                    operator: document.getElementById('operator-name').value.trim(),
                    lastUpdated: new Date().toISOString(),
                    updatedBy: currentUser.name,
                    updatedByShift: currentUser.shift,
                    dailyNotes: document.getElementById('dailyNotes').value.trim(),
                    readings: {},
                    additional: {
                        waterPath: document.getElementById('waterPath').value.trim(),
                        tank1Level: document.getElementById('tank1Level').value.trim(),
                        tank2Level: document.getElementById('tank2Level').value.trim(),
                        tank3Level: document.getElementById('tank3Level').value.trim(),
                        compressor1: document.getElementById('compressor1').value.trim(),
                        compressor2: document.getElementById('compressor2').value.trim(),
                        compressor: document.getElementById('com').value.trim(),
                        startTime: document.getElementById('startTime').value,
                        endTime: document.getElementById('endTime').value,
                        totalHours: document.getElementById('totalHours').value.trim(),
                        status: 'تعمل' // يمكن تغييرها حسب المنطق
                    }
                };

                // جمع قراءات الجدول
                document.querySelectorAll('.data-input').forEach(input => {
                    if (input.value.trim()) {
                        stationData.readings[input.id] = input.value.trim();
                    }
                });

                // حساب ساعات التشغيل
                calculateTotalHours();

                // تحديث البيانات المحلية
                currentStation.data = stationData;

                // حفظ في Firebase
                await database.ref(`stations/${currentStation.id}`).update({
                    data: stationData,
                    lockedBy: null,
                    lockTime: null
                });

                // تحديث البيانات المحلية
                currentStation.lockedBy = null;
                currentStation.lockTime = null;

                // تحديث الواجهة
                document.getElementById('currentEditorInfo').style.display = 'none';
                document.getElementById('unlockBtn').style.display = 'none';
                createStationCards();

                showNotification('تم حفظ البيانات بنجاح', 'success');

                // تحديث وقت آخر تحديث
                document.getElementById('lastUpdateTime').textContent = 
                    `آخر تحديث: ${new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;

            } catch (error) {
                showNotification('حدث خطأ أثناء حفظ البيانات', 'error');
                console.error('Error saving station data:', error);
            } finally {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
            }
        }

        // ========== إلغاء قفل المحطة ==========
        async function unlockStation() {
            if (!currentStation) {
                showNotification('لا توجد محطة محددة', 'warning');
                return;
            }

            try {
                await database.ref(`stations/${currentStation.id}`).update({
                    lockedBy: null,
                    lockTime: null
                });

                // تحديث البيانات المحلية
                currentStation.lockedBy = null;
                currentStation.lockTime = null;

                // تحديث الواجهة
                document.getElementById('currentEditorInfo').style.display = 'none';
                document.getElementById('unlockBtn').style.display = 'none';
                createStationCards();

                showNotification('تم إلغاء قفل المحطة', 'success');
            } catch (error) {
                showNotification('حدث خطأ أثناء إلغاء القفل', 'error');
            }
        }

        // ========== حساب ساعات التشغيل ==========
        function calculateTotalHours() {
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;

            if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);

                if (end < start) {
                    end.setDate(end.getDate() + 1);
                }

                const diffMs = end - start;
                const diffHours = diffMs / (1000 * 60 * 60);

                document.getElementById("totalHours").value = diffHours.toFixed(2);
            }
        }

        // ========== تصدير إلى Excel ==========
        function exportToExcel() {
            if (!currentStation) {
                showNotification('يجب تحديد محطة أولاً', 'warning');
                return;
            }

            const wsData = [];
            wsData.push(["سجل محطة ضخ - بيانات المحطة"]);
            wsData.push([]);
            wsData.push(["اسم المحطة", currentStation.name]);
            wsData.push(["اسم المشغل", currentStation.data.operator || '']);
            wsData.push(["التاريخ", document.getElementById("record-date").value]);
            wsData.push(["الوردية", document.getElementById("shift").value]);
            wsData.push([]);
            wsData.push(["بيانات الوحدات"]);
            wsData.push([]);

            const tableHeaders = ["البيان", "6:00 ص", "11:00 ص", "4:00 م", "9:00 م", "2:00 ص"];
            wsData.push(tableHeaders);

            // جمع بيانات الجدول
            const rows = document.querySelectorAll("#pumpTable tbody tr");
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll("td");
                cells.forEach((cell, index) => {
                    if (index === 0) {
                        rowData.push(cell.textContent);
                    } else if (index <= 5) {
                        const input = cell.querySelector("input");
                        rowData.push(input ? input.value : "");
                    }
                });
                wsData.push(rowData);
            });

            wsData.push([]);
            wsData.push(["بيانات إضافية"]);
            wsData.push([]);

            const additionalData = [
                ["الطرق المائي", document.getElementById("waterPath").value],
                ["مستوي المياه بالخزان الأول", document.getElementById("tank1Level").value],
                ["مستوي المياه بالخزان الثاني", document.getElementById("tank2Level").value],
                ["مستوي المياه بالخزان الثالث", document.getElementById("tank3Level").value],
                ["مستوي الزيت بالضاغط الأول / درجة الحرارة", document.getElementById("compressor1").value],
                ["مستوي الزيت بالضاغط الثاني / درجة الحرارة", document.getElementById("compressor2").value],
                ["مستوي الزيت بالضاغط / درجة الحرارة", document.getElementById("com").value],
                ["توقيت تشغيل المحطة", document.getElementById("startTime").value],
                ["توقيت إيقاف المحطة", document.getElementById("endTime").value],
                ["عدد ساعات تشغيل المحطة خلال اليوم", document.getElementById("totalHours").value],
                ["ملاحظات اليوم", document.getElementById("dailyNotes").value]
            ];

            additionalData.forEach(item => wsData.push(item));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            const wscols = [{ wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
            ws["!cols"] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "سجل محطة الضخ");

            const fileName = `${currentStation.name}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showNotification("تم تصدير البيانات إلى ملف Excel", "success");
        }

        // ========== تحميل البيانات من Firebase ==========
        function loadFromFirebase() {
            database.ref('stations').on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                
                if (firebaseData) {
                    // تحديث البيانات المحلية ببيانات Firebase
                    allStations.forEach(station => {
                        const fbStation = firebaseData[station.id];
                        if (fbStation) {
                            // تحديث البيانات الرئيسية
                            station.data = fbStation.data || station.data;
                            station.lockedBy = fbStation.lockedBy || null;
                            station.lockTime = fbStation.lockTime || null;
                        }
                    });

                    // تحديث الواجهة
                    createStationCards();

                    // إذا كانت المحطة الحالية محددة، تحديثها
                    if (currentStation) {
                        const updatedStation = allStations.find(s => s.id === currentStation.id);
                        if (updatedStation) {
                            currentStation = updatedStation;
                            
                            // إذا كانت هناك تحديثات جديدة، عرض تنبيه
                            if (updatedStation.data.lastUpdated !== currentStation.data.lastUpdated) {
                                const date = new Date(updatedStation.data.lastUpdated);
                                const timeStr = date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                                showNotification(`تم تحديث بيانات ${updatedStation.name} بواسطة ${updatedStation.data.updatedBy} في ${timeStr}`, 'info');
                            }
                        }
                    }

                    // تحديث وقت آخر تحديث
                    document.getElementById('lastUpdateTime').textContent = 
                        `آخر تحديث: ${new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
                }
            }, (error) => {
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-wifi-slash"></i><span>غير متصل - وضع عدم الاتصال</span>';
                document.getElementById('syncStatus').className = 'sync-status offline';
                showNotification('تم الانتقال إلى وضع عدم الاتصال', 'warning');
            });
        }

        // ========== إنشاء الجدول الأصلي ==========
        function createOriginalTable() {
            pumpUnits = [{
                name: "معلومات",
                items: [{
                    name: "المنسوب",
                    id: "level1",
                    unit: "سم",
                    inputType: "mixed",
                    placeholder: "أدخل المنسوب بالسم"
                }, {
                    name: "قراءة عداد الطاقة",
                    id: "energy1",
                    unit: "ك.و.س",
                    inputType: "number",
                    placeholder: "أدخل قراءة العداد"
                }, {
                    name: "قراءة عداد الطاقة ٢",
                    id: "energy2",
                    unit: "ك.و.س",
                    inputType: "number",
                    placeholder: "أدخل القراءة الثانية"
                }, {
                    name: "الجهد",
                    id: "voltage1",
                    unit: "فولت",
                    inputType: "number",
                    placeholder: "أدخل الجهد بالفولت"
                }, {
                    name: "الضغط",
                    id: "daght",
                    unit: "بار",
                    inputType: "number",
                    placeholder: "أدخل الضغط بالبار"
                }]
            }, {
                name: "الوحدة رقم ١",
                type: "unit",
                unitNumber: 1,
                items: [{
                    name: "إجمالي عدد الساعات",
                    id: "totalHours1",
                    unit: "ساعة",
                    inputType: "number",
                    placeholder: "أدخل عدد الساعات"
                }, {
                    name: "فتحة محبس الطرد (%)",
                    id: "valve1",
                    unit: "%",
                    inputType: "number",
                    placeholder: "أدخل النسبة المئوية"
                }, {
                    name: "ضغط سحب المضخة",
                    id: "suction1",
                    unit: "بار",
                    inputType: "number",
                    placeholder: "أدخل الضغط بالبار"
                }, {
                    name: "ضغط طرد المضخة",
                    id: "discharge1",
                    unit: "بار",
                    inputType: "number",
                    placeholder: "أدخل الضغط بالبار"
                }, {
                    name: "حالة حرارة كرسي التحميل",
                    id: "bearing1",
                    unit: "°C",
                    inputType: "mixed",
                    placeholder: "أدخل الحرارة أو الحالة"
                }, {
                    name: "حالة الحشو",
                    id: "seal1",
                    unit: "",
                    inputType: "text",
                    placeholder: "أدخل حالة الحشو"
                }, {
                    name: "درجة حرارة الموتور",
                    id: "motorTemp1",
                    unit: "",
                    inputType: "mixed",
                    placeholder: "أدخل درجة الحرارة أو الحالة"
                }, {
                    name: "شدة تيار الموتور",
                    id: "motorCurrent1",
                    unit: "أمبير",
                    inputType: "number",
                    placeholder: "أدخل شدة التيار"
                }]
            }, {
                name: "الوحدة رقم ٢",
                type: "unit",
                unitNumber: 2,
                items: [{
                    name: "إجمالي عدد الساعات",
                    id: "totalHours2",
                    unit: "ساعة",
                    inputType: "number",
                    placeholder: "أدخل عدد الساعات"
                }, {
                    name: "فتحة محبس الطرد (%)",
                    id: "valve2",
                    unit: "%",
                    inputType: "number",
                    placeholder: "أدخل النسبة المئوية"
                }, {
                    name: "ضغط سحب المضخة",
                    id: "suction2",
                    unit: "بار",
                    inputType: "number",
                    placeholder: "أدخل الضغط بالبار"
                }, {
                    name: "ضغط طرد المضخة",
                    id: "discharge2",
                    unit: "بار",
                    inputType: "number",
                    placeholder: "أدخل الضغط بالبار"
                }, {
                    name: "حالة حرارة كرسي التحميل",
                    id: "bearing2",
                    unit: "°C",
                    inputType: "mixed",
                    placeholder: "أدخل الحرارة أو الحالة"
                }, {
                    name: "حالة الحشو",
                    id: "seal2",
                    unit: "",
                    inputType: "text",
                    placeholder: "أدخل حالة الحشو"
                }, {
                    name: "درجة حرارة الموتور",
                    id: "motorTemp2",
                    unit: "",
                    inputType: "mixed",
                    placeholder: "أدخل درجة الحرارة أو الحالة"
                }, {
                    name: "شدة تيار الموتور",
                    id: "motorCurrent2",
                    unit: "أمبير",
                    inputType: "number",
                    placeholder: "أدخل شدة التيار"
                }]
            }];

            const timeSlots = ["6:00", "11:00", "16:00", "21:00", "2:00"];
            const tableBody = document.getElementById("tableBody");

            function generateTable() {
                tableBody.innerHTML = "";

                const sortedUnits = [...pumpUnits];
                sortedUnits.sort((a, b) => {
                    if (a.name === "معلومات") return -1;
                    if (b.name === "معلومات") return 1;
                    if (a.unitNumber && b.unitNumber) {
                        return a.unitNumber - b.unitNumber;
                    }
                    return 0;
                });

                sortedUnits.forEach((unit) => {
                    const unitHeaderRow = document.createElement("tr");
                    const unitHeaderCell = document.createElement("td");
                    unitHeaderCell.colSpan = 6;
                    unitHeaderCell.textContent = unit.name;
                    unitHeaderCell.className = "unit-header";
                    unitHeaderRow.appendChild(unitHeaderCell);
                    tableBody.appendChild(unitHeaderRow);

                    unit.items.forEach((item) => {
                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.textContent = item.name;
                        row.appendChild(nameCell);

                        timeSlots.forEach((time, timeIndex) => {
                            const inputCell = document.createElement("td");
                            const input = document.createElement("input");

                            input.type = "text";
                            input.className = "data-input";
                            input.placeholder = item.placeholder || "أدخل القيمة";
                            input.id = `${item.id}_${timeIndex}`;
                            input.setAttribute("autocomplete", "off");

                            inputCell.appendChild(input);
                            row.appendChild(inputCell);
                        });

                        tableBody.appendChild(row);
                    });
                });
            }

            generateTable();

            // إضافة وحدة جديدة (اختياري)
            document.getElementById("addRowBtn")?.addEventListener("click", function() {
                let maxUnitNumber = 2;
                pumpUnits.forEach(unit => {
                    if (unit.type === "unit" && unit.unitNumber > maxUnitNumber) {
                        maxUnitNumber = unit.unitNumber;
                    }
                });

                const nextUnitNumber = maxUnitNumber + 1;
                if (nextUnitNumber > 9) {
                    showNotification("الحد الأقصى للوحدات هو 9 وحدات", "warning");
                    return;
                }

                const newUnit = {
                    name: `الوحدة رقم ${nextUnitNumber}`,
                    type: "unit",
                    unitNumber: nextUnitNumber,
                    items: [...pumpUnits[1].items.map(item => ({ ...item, id: item.id.replace(/[0-9]/g, nextUnitNumber) }))]
                };

                pumpUnits.push(newUnit);
                generateTable();
                showNotification("تم إضافة وحدة جديدة", "success");
            });
        }

        // ========== إعداد النظام ==========
        function initSystem() {
            // توليد المحطات
            allStations = generateStations();

            // استعادة بيانات المستخدم
            const savedUser = localStorage.getItem('pump_user_data');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    document.getElementById('userName').value = userData.name || '';
                    document.getElementById('userId').value = userData.id || '';
                    currentUser.name = userData.name;
                    currentUser.id = userData.id;
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }

            // استعادة الوردية
            const savedShift = localStorage.getItem('current_shift');
            if (savedShift) {
                currentUser.shift = savedShift;
            }
            updateShiftDisplay();

            // تعيين التاريخ الحالي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('record-date').value = today;
            document.getElementById('record-date').min = today;
            document.getElementById('record-date').max = today;

            // إنشاء البطاقات
            createStationCards();

            // إنشاء الجدول الأصلي
            createOriginalTable();

            // تحميل البيانات من Firebase
            loadFromFirebase();

            // إعداد المستمعين للأحداث
            setupEventListeners();

            // إخفاء شاشة التحميل
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                showNotification('تم تحميل النظام بنجاح', 'success');
            }, 1000);
        }

        // ========== إعداد مستمعي الأحداث ==========
        function setupEventListeners() {
            // حفظ بيانات المستخدم
            document.getElementById('userName').addEventListener('change', function() {
                currentUser.name = this.value.trim();
                localStorage.setItem('pump_user_data', JSON.stringify({
                    name: currentUser.name,
                    id: currentUser.id
                }));
            });

            document.getElementById('userId').addEventListener('change', function() {
                currentUser.id = this.value.trim();
                localStorage.setItem('pump_user_data', JSON.stringify({
                    name: currentUser.name,
                    id: currentUser.id
                }));
            });

            // أزرار الوردية
            document.getElementById('dayShiftBtn').addEventListener('click', () => switchShift('day'));
            document.getElementById('nightShiftBtn').addEventListener('click', () => switchShift('night'));

            // أزرار النموذج
            document.getElementById('saveBtn').addEventListener('click', saveStationData);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('printBtn').addEventListener('click', () => window.print());
            document.getElementById('unlockBtn').addEventListener('click', unlockStation);

            // حساب ساعات التشغيل
            document.getElementById('startTime').addEventListener('change', calculateTotalHours);
            document.getElementById('endTime').addEventListener('change', calculateTotalHours);

            // زر إضافة وحدة (إذا كان موجود)
            if (document.getElementById('addRowBtn')) {
                document.getElementById('addRowBtn').addEventListener('click', function() {
                    // تم التعامل معه في createOriginalTable
                });
            }
        }

        // ========== بدء النظام ==========
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
