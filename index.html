<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ø³Ø¬Ù„ Ù…Ø­Ø·Ø© Ù†Ù…ÙˆØ°Ø¬ 8 - Ù…ØªØµÙ„</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 10px;
            background-color: #f5f9ff;
            color: #333;
            direction: rtl;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³ÙÙ„ÙŠ */
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2c5aa0;
        }
        
        h1 {
            color: #2c5aa0;
            margin-bottom: 5px;
            font-size: 1.4rem;
            line-height: 1.3;
        }
        
        h1 i {
            font-size: 1.2rem;
            margin-left: 8px;
        }
        
        .header-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #eef5ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            border: 1px solid #dae8fc;
        }
        
        .header-name {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .info-item label {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .info-item input,
        .info-item select {
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            width: 100%;
            height: 42px;
            background: white;
        }
        
        input[type="date"] {
            min-height: 42px;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding: 12px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            flex: 1;
            min-width: 140px;
            height: 48px;
        }
        
        .btn i {
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: #2c5aa0;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d3d75;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-top: 3px solid #2c5aa0;
        }

        .status-text {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online { background-color: #28a745; box-shadow: 0 0 5px #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-loading { background-color: #ffc107; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0.5; } }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 10px 6px;
            text-align: center;
            font-size: 13px;
            min-width: 90px;
        }
        
        th {
            background-color: #2c5aa0;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f7ff;
        }
        
        .unit-header {
            background-color: #e7f1ff !important;
            font-weight: bold;
            color: #1d3d75;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 13px;
            height: 36px;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid #2c5aa0;
            outline-offset: -1px;
        }
        
        .section-title,
        .section-to,
        .section-tox {
            background-color: #1d3d75;
            color: white;
            padding: 12px 10px;
            margin: 20px 0 15px 0;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            line-height: 1.4;
        }
        
        .section-title i,
        .section-to i,
        .section-tox i {
            margin-left: 8px;
            font-size: 16px;
        }
        
        .footer-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }
        
        .footer-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .footer-col,
        .footer-col1 {
            width: 100%;
            text-align: center;
        }
        
        .footer-col label,
        .footer-col1 label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            color: #1d3d75;
            font-size: 0.95rem;
        }
        
        .notes {
            margin-top: 15px;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            height: 90px;
            resize: vertical;
            min-height: 90px;
        }
        
        .time-slots {
            display: flex;
            justify-content: space-between;
            background-color: #e7f1ff;
            padding: 10px 5px;
            border-radius: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .time-slot {
            font-weight: bold;
            color: #1d3d75;
            font-size: 12px;
            text-align: center;
            flex: 1;
            min-width: 60px;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1001;
            left: 50%;
            bottom: 80px;
            transform: translateX(-50%);
            font-size: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 80px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 80px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„ÙˆØ­ÙŠØ© ÙˆØ§Ù„Ù…ÙƒØªØ¨ÙŠØ© */
        @media (min-width: 768px) {
            body { padding: 15px; font-size: 15px; }
            .container { padding: 20px; border-radius: 10px; }
            h1 { font-size: 1.6rem; }
            .header-info { flex-direction: row; flex-wrap: wrap; }
            .info-item { flex: 1; min-width: 200px; }
            .header-name { flex-direction: row; flex: 2; }
            .controls { flex-direction: row; justify-content: space-between; }
            .footer-row { flex-direction: row; flex-wrap: wrap; }
            .footer-col, .footer-col1 { flex: 1; min-width: 200px; }
        }
        
        @media print {
            .controls, .status-bar, .toast { display: none !important; }
            .container { padding-bottom: 0; box-shadow: none; }
            body { background: white; }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>
                <i class="fas fa-network-wired"></i> Ø³Ø¬Ù„ Ù…Ø­Ø·Ø© (Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†) - Ù†Ù…ÙˆØ°Ø¬ 8
            </h1>
            <p style="color: #666; margin-top: 5px;">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ø¨ÙŠÙ† Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª</p>

            <div class="header-info">
                <div class="info-item">
                    <label for="record-date">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ø¬Ù„ (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹):</label>
                    <input type="date" id="record-date" value="" />
                </div>
                <div class="header-name">
                    <div class="info-item">
                        <label for="shift">Ø§Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
                        <select id="shift">
                            <option value="ØµØ¨Ø§Ø­ÙŠØ©">ØµØ¨Ø§Ø­ÙŠØ© (6 Øµ - 4 Ù…)</option>
                            <option value="Ù…Ø³Ø§Ø¦ÙŠØ©">Ù…Ø³Ø§Ø¦ÙŠØ© (4 Ù… - 6 Øµ)</option>
                        </select>
                    </div>
                    <div class="info-item">
                        <label for="operator-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØºÙ„:</label>
                        <input type="text" id="operator-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />
                    </div>
                    <div class="info-item">
                        <label for="station-name">Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©:</label>
                        <input type="text" id="station-name" value="Ù…Ø­Ø·Ø© Ø§Ù„Ø¶Ø® Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" />
                    </div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="btn-group">
                <button class="btn btn-primary" id="saveDbBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†
                </button>
                <button class="btn btn-warning" id="loadDbBtn">
                    <i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="addRowBtn">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©
                </button>
                <button class="btn btn-success" id="exportBtn">
                    <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel
                </button>
                <button class="btn btn-secondary" id="printBtn">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </div>

        <div class="time-slots">
            <div class="time-slot">6:00 Øµ</div>
            <div class="time-slot">11:00 Øµ</div>
            <div class="time-slot">4:00 Ù…</div>
            <div class="time-slot">9:00 Ù…</div>
            <div class="time-slot">2:00 Øµ</div>
        </div>

        <div class="table-container">
            <table id="pumpTable">
                <thead>
                    <tr>
                        <th rowspan="2">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                        <th colspan="5">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</th>
                    </tr>
                    <tr>
                        <th>6:00 Øµ</th>
                        <th>11:00 Øµ</th>
                        <th>4:00 Ù…</th>
                        <th>9:00 Ù…</th>
                        <th>2:00 Øµ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="section-title">
            <i class="fas fa-tachometer-alt"></i> Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ø§Ø¦ÙŠ Ùˆ Ø¶Ø§ØºØ· Ø§Ù„Ù‡ÙˆØ§Ø¡
        </div>

        <div class="footer-section">
            <div class="footer-row">
                <div class="footer-col">
                    <label>Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ø§Ø¦ÙŠ:</label>
                    <input type="text" id="waterPath" placeholder="Ø£Ø¯Ø®Ù„ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù…Ø§Ø¦ÙŠ" />
                </div>
                <div class="footer-col">
                    <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¨Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ø£ÙˆÙ„:</label>
                    <input type="text" id="tank1Level" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠ" />
                </div>
                <div class="footer-col">
                    <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¨Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
                    <input type="text" id="tank2Level" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠ" />
                </div>
            </div>

            <div class="footer-row">
                <div class="footer-col">
                    <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ù…ÙŠØ§Ù‡ Ø¨Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ø«Ø§Ù„Ø«:</label>
                    <input type="text" id="tank3Level" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙŠ" />
                </div>
                <div class="footer-col">
                    <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ø²ÙŠØª Ø¨Ø§Ù„Ø¶Ø§ØºØ· Ø§Ù„Ø£ÙˆÙ„ / Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</label>
                    <input type="text" id="compressor1" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" />
                </div>
                <div class="footer-col">
                    <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ø²ÙŠØª Ø¨Ø§Ù„Ø¶Ø§ØºØ· Ø§Ù„Ø«Ø§Ù†ÙŠ / Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</label>
                    <input type="text" id="compressor2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" />
                </div>
            </div>

            <div class="section-to">
                <i class="fas fa-tachometer-alt"></i> Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±
            </div>

            <div class="footer-col1">
                <label>Ù…Ø³ØªÙˆÙŠ Ø§Ù„Ø²ÙŠØª Ø¨Ø§Ù„Ø¶Ø§ØºØ· / Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</label>
                <input type="text" id="com" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" />
            </div>

            <div class="section-tox">
                <i class="fas fa-clock"></i> Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ \ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ù„Ù„Ù…Ø­Ø·Ø©
            </div>

            <div class="footer-row">
                <div class="footer-col">
                    <label>ØªÙˆÙ‚ÙŠØª ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø·Ø©:</label>
                    <input type="time" id="startTime" value="06:00" />
                </div>
                <div class="footer-col">
                    <label>ØªÙˆÙ‚ÙŠØª Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø·Ø©:</label>
                    <input type="time" id="endTime" value="24:00" />
                </div>
                <div class="footer-col">
                    <label>Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„:</label>
                    <input type="number" id="totalHours" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" readonly style="background-color: #eee;" />
                </div>
            </div>

            <div class="notes">
                <label for="dailyNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</label>
                <textarea id="dailyNotes" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø© Ù„Ù„ÙˆØ±Ø¯ÙŠØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©..."></textarea>
            </div>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠ -->
    <div class="status-bar">
        <div class="status-text" id="connectionStatus">
            <span class="status-indicator status-loading" id="statusDot"></span>
            <span id="statusMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</span>
        </div>
        <button class="btn btn-primary" style="min-width: 100px; height: 36px; font-size: 13px;" onclick="saveData()">
            Ø­ÙØ¸ Ø§Ù„Ø¢Ù†
        </button>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© -->
    <div id="toast" class="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>

    <!-- Firebase Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'station-log-app';

        let currentUser = null;
        let unsubscribeSnapshot = null;
        
        // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                     await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                updateStatus('offline', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                updateStatus('online', 'Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                loadDataForDate();
            } else {
                updateStatus('offline', 'ØºÙŠØ± Ù…ØªØµÙ„');
            }
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        initAuth();

        // ---------------------------------------------------------
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ---------------------------------------------------------

        function getDocRef() {
            const dateStr = document.getElementById('record-date').value;
            return doc(db, 'artifacts', appId, 'public', 'data', 'station_logs', dateStr);
        }

        window.saveData = async function() {
            if (!currentUser) {
                showToast("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„...");
                return;
            }

            const dateStr = document.getElementById('record-date').value;
            if (!dateStr) {
                showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            updateStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');

            try {
                const formData = {
                    metadata: {
                        stationName: document.getElementById('station-name').value,
                        operatorName: document.getElementById('operator-name').value,
                        shift: document.getElementById('shift').value,
                        lastUpdated: new Date().toISOString(),
                        updatedBy: currentUser.uid
                    },
                    unitsStructure: pumpUnits.map(u => ({
                        name: u.name,
                        type: u.type || 'info',
                        unitNumber: u.unitNumber || 0,
                        items: u.items.map(i => ({ name: i.name, id: i.id, unit: i.unit }))
                    })),
                    values: {},
                    footerData: {
                        waterPath: document.getElementById('waterPath').value,
                        tank1Level: document.getElementById('tank1Level').value,
                        tank2Level: document.getElementById('tank2Level').value,
                        tank3Level: document.getElementById('tank3Level').value,
                        compressor1: document.getElementById('compressor1').value,
                        compressor2: document.getElementById('compressor2').value,
                        com: document.getElementById('com').value,
                        startTime: document.getElementById('startTime').value,
                        endTime: document.getElementById('endTime').value,
                        totalHours: document.getElementById('totalHours').value,
                        dailyNotes: document.getElementById('dailyNotes').value
                    }
                };

                const inputs = document.querySelectorAll('.data-input');
                inputs.forEach(input => {
                    if (input.value) {
                        formData.values[input.id] = input.value;
                    }
                });

                await setDoc(getDocRef(), formData, { merge: true });
                
                showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                updateStatus('online', 'ØªÙ… Ø§Ù„Ø­ÙØ¸ - Ù…ØªØµÙ„');

            } catch (error) {
                console.error("Save Error:", error);
                showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸!");
                updateStatus('offline', 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸');
            }
        };

        window.loadDataForDate = function() {
            if (!currentUser) return;
            
            const dateStr = document.getElementById('record-date').value;
            if (!dateStr) return;

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
            }

            updateStatus('loading', 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…...');

            unsubscribeSnapshot = onSnapshot(getDocRef(), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    populateForm(data);
                    updateStatus('online', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©');
                } else {
                    updateStatus('online', 'Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…');
                }
            }, (error) => {
                console.error("Listen Error:", error);
                updateStatus('offline', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            });
        };

        function populateForm(data) {
            if (data.unitsStructure && data.unitsStructure.length > 0) {
                pumpUnits.length = 0;
                data.unitsStructure.forEach(u => pumpUnits.push(u));
                generateTable();
            }

            if (data.metadata) {
                if (data.metadata.stationName) document.getElementById('station-name').value = data.metadata.stationName;
                if (!document.getElementById('operator-name').value && data.metadata.operatorName) {
                    document.getElementById('operator-name').value = data.metadata.operatorName;
                }
            }

            if (data.footerData) {
                const map = {
                    waterPath: data.footerData.waterPath,
                    tank1Level: data.footerData.tank1Level,
                    tank2Level: data.footerData.tank2Level,
                    tank3Level: data.footerData.tank3Level,
                    compressor1: data.footerData.compressor1,
                    compressor2: data.footerData.compressor2,
                    com: data.footerData.com,
                    startTime: data.footerData.startTime,
                    endTime: data.footerData.endTime,
                    totalHours: data.footerData.totalHours,
                    dailyNotes: data.footerData.dailyNotes
                };
                
                for (const [id, val] of Object.entries(map)) {
                    const el = document.getElementById(id);
                    if (el && val !== undefined) el.value = val;
                }
            }

            if (data.values) {
                document.querySelectorAll('.data-input').forEach(inp => inp.value = "");
                for (const [id, val] of Object.entries(data.values)) {
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                }
            }
        }
        
        function updateStatus(state, msg) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusMessage');
            txt.textContent = msg;
            dot.className = 'status-indicator';
            if (state === 'online') dot.classList.add('status-online');
            else if (state === 'offline') dot.classList.add('status-offline');
            else if (state === 'loading') dot.classList.add('status-loading');
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.textContent = msg;
            x.className = "toast show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        document.getElementById('saveDbBtn').addEventListener('click', window.saveData);
        document.getElementById('loadDbBtn').addEventListener('click', window.loadDataForDate);
        document.getElementById('record-date').addEventListener('change', window.loadDataForDate);

    </script>

    <script>
        // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        const dateInput = document.getElementById("record-date");
        if (!dateInput.value) {
            dateInput.valueAsDate = new Date();
        }

        const pumpUnits = [{
            name: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
            type: "info",
            items: [{
                name: "Ø§Ù„Ù…Ù†Ø³ÙˆØ¨",
                id: "level1",
                unit: "Ù…"
            }, {
                name: "Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§Ù‚Ø©",
                id: "energy1",
                unit: "Ùƒ.Ùˆ.Ø³"
            }, {
                name: "Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø§Ù‚Ø© Ù¢",
                id: "energy2",
                unit: "Ùƒ.Ùˆ.Ø³"
            }, {
                name: "Ø§Ù„Ø¬Ù‡Ø¯",
                id: "voltage1",
                unit: "ÙÙˆÙ„Øª"
            }, {
                name: "Ø§Ù„Ø¶ØºØ·",
                id: "daght",
                unit: "bar"
            }]
        }, {
            name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… Ù¡",
            type: "unit",
            unitNumber: 1,
            items: [{
                name: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª",
                id: "totalHours1",
                unit: "Ø³Ø§Ø¹Ø©"
            }, {
                name: "Ø·Ù„Ù…Ø¨Ø© Ù¡",
                id: "pump1",
                unit: ""
            }, {
                name: "ÙØªØ­Ø© Ù…Ø­Ø¨Ø³ Ø§Ù„Ø·Ø±Ø¯ (%)",
                id: "valve1",
                unit: "%"
            }, {
                name: "Ø¶ØºØ· Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¶Ø®Ø©",
                id: "suction1",
                unit: "Ø¨Ø§Ø±"
            }, {
                name: "Ø¶ØºØ· Ø·Ø±Ø¯ Ø§Ù„Ù…Ø¶Ø®Ø©",
                id: "discharge1",
                unit: "Ø¨Ø§Ø±"
            }, {
                name: "Ø­Ø§Ù„Ø© Ø­Ø±Ø§Ø±Ø© ÙƒØ±Ø³ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
                id: "bearing1",
                unit: "Â°C"
            }, {
                name: "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø´Ùˆ",
                id: "seal1",
                unit: ""
            }, {
                name: "Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØªÙˆØ±",
                id: "motorTemp1",
                unit: "Â°C"
            }, {
                name: "Ø´Ø¯Ø© ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØªÙˆØ±",
                id: "motorCurrent1",
                unit: "Ø£Ù…Ø¨ÙŠØ±"
            }]
        }, {
            name: "Ø§Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… Ù¢",
            type: "unit",
            unitNumber: 2,
            items: [{
                name: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª",
                id: "totalHours2",
                unit: "Ø³Ø§Ø¹Ø©"
            }, {
                name: "ÙØªØ­Ø© Ù…Ø­Ø¨Ø³ Ø§Ù„Ø·Ø±Ø¯ (%)",
                id: "valve2",
                unit: "%"
            }, {
                name: "Ø¶ØºØ· Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¶Ø®Ø©",
                id: "suction2",
                unit: "Ø¨Ø§Ø±"
            }, {
                name: "Ø¶ØºØ· Ø·Ø±Ø¯ Ø§Ù„Ù…Ø¶Ø®Ø©",
                id: "discharge2",
                unit: "Ø¨Ø§Ø±"
            }, {
                name: "Ø­Ø§Ù„Ø© Ø­Ø±Ø§Ø±Ø© ÙƒØ±Ø³ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„",
                id: "bearing2",
                unit: "Â°C"
            }, {
                name: "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø´Ùˆ",
                id: "seal2",
                unit: ""
            }, {
                name: "Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØªÙˆØ±",
                id: "motorTemp2",
                unit: "Â°C"
            }, {
                name: "Ø´Ø¯Ø© ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØªÙˆØ±",
                id: "motorCurrent2",
                unit: "Ø£Ù…Ø¨ÙŠØ±"
            }]
        }];

        const timeSlots = ["6:00", "11:00", "16:00", "21:00", "2:00"];
        const tableBody = document.getElementById("tableBody");

        window.generateTable = function() {
            tableBody.innerHTML = "";
            pumpUnits.forEach((unit) => {
                const unitHeaderRow = document.createElement("tr");
                const unitHeaderCell = document.createElement("td");
                unitHeaderCell.colSpan = 6;
                unitHeaderCell.textContent = unit.name;
                unitHeaderCell.className = "unit-header";
                unitHeaderRow.appendChild(unitHeaderCell);
                tableBody.appendChild(unitHeaderRow);

                unit.items.forEach((item) => {
                    const row = document.createElement("tr");
                    const nameCell = document.createElement("td");
                    nameCell.textContent = item.name;
                    row.appendChild(nameCell);

                    timeSlots.forEach((time, timeIndex) => {
                        const inputCell = document.createElement("td");
                        const input = document.createElement("input");
                        input.type = "text";
                        input.placeholder = item.unit ? `${item.unit}` : "-";
                        input.id = `${item.id}_${timeIndex}`;
                        input.className = "data-input";
                        input.setAttribute("inputmode", "decimal");
                        inputCell.appendChild(input);
                        row.appendChild(inputCell);
                    });
                    tableBody.appendChild(row);
                });
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            window.generateTable();
        });

        document.getElementById("addRowBtn").addEventListener("click", function() {
            let maxUnitNumber = 0;
            pumpUnits.forEach(unit => {
                if (unit.type === "unit" && unit.unitNumber > maxUnitNumber) {
                    maxUnitNumber = unit.unitNumber;
                }
            });
            const nextUnitNumber = maxUnitNumber + 1;
            if (nextUnitNumber > 10) { alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙˆØ­Ø¯Ø§Øª Ù‡Ùˆ 10"); return; }
            const newUnit = {
                name: `Ø§Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù… ${nextUnitNumber}`,
                type: "unit",
                unitNumber: nextUnitNumber,
                items: [
                    { name: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª", id: `totalHours${nextUnitNumber}`, unit: "Ø³Ø§Ø¹Ø©" },
                    { name: "ÙØªØ­Ø© Ù…Ø­Ø¨Ø³ Ø§Ù„Ø·Ø±Ø¯ (%)", id: `valve${nextUnitNumber}`, unit: "%" },
                    { name: "Ø¶ØºØ· Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¶Ø®Ø©", id: `suction${nextUnitNumber}`, unit: "Ø¨Ø§Ø±" },
                    { name: "Ø¶ØºØ· Ø·Ø±Ø¯ Ø§Ù„Ù…Ø¶Ø®Ø©", id: `discharge${nextUnitNumber}`, unit: "Ø¨Ø§Ø±" },
                    { name: "Ø­Ø§Ù„Ø© Ø­Ø±Ø§Ø±Ø© ÙƒØ±Ø³ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", id: `bearing${nextUnitNumber}`, unit: "Â°C" },
                    { name: "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø´Ùˆ", id: `seal${nextUnitNumber}`, unit: "" },
                    { name: "Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØªÙˆØ±", id: `motorTemp${nextUnitNumber}`, unit: "Â°C" },
                    { name: "Ø´Ø¯Ø© ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØªÙˆØ±", id: `motorCurrent${nextUnitNumber}`, unit: "Ø£Ù…Ø¨ÙŠØ±" }
                ]
            };
            pumpUnits.push(newUnit);
            window.generateTable();
            window.saveData();
        });

        document.getElementById("printBtn").addEventListener("click", () => window.print());
        document.getElementById("exportBtn").addEventListener("click", exportToExcel);

        function exportToExcel() {
            const wsData = [];
            wsData.push(["Ø³Ø¬Ù„ Ù…Ø­Ø·Ø© Ø¶Ø® - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø·Ø©"]);
            wsData.push(["Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©", document.getElementById("station-name").value]);
            wsData.push(["Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØºÙ„", document.getElementById("operator-name").value]);
            wsData.push(["Ø§Ù„ØªØ§Ø±ÙŠØ®", document.getElementById("record-date").value]);
            wsData.push(["Ø§Ù„ÙˆØ±Ø¯ÙŠØ©", document.getElementById("shift").value]);
            wsData.push([]);
            const tableHeaders = ["Ø§Ù„Ø¨ÙŠØ§Ù†", "6:00 Øµ", "11:00 Øµ", "4:00 Ù…", "9:00 Ù…", "2:00 Øµ"];
            wsData.push(tableHeaders);
            const rows = document.querySelectorAll("#pumpTable tbody tr");
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll("td");
                cells.forEach((cell, index) => {
                    if (index === 0) rowData.push(cell.textContent);
                    else {
                        const input = cell.querySelector("input");
                        rowData.push(input ? input.value : "");
                    }
                });
                if (rowData.length > 0) wsData.push(rowData);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Ø³Ø¬Ù„ Ø§Ù„ÙˆØ±Ø¯ÙŠØ©");
            XLSX.writeFile(wb, `Station_Log_${document.getElementById("record-date").value}.xlsx`);
        }

        document.getElementById("startTime").addEventListener("change", calculateTotalHours);
        document.getElementById("endTime").addEventListener("change", calculateTotalHours);

        function calculateTotalHours() {
            const startTime = document.getElementById("startTime").value;
            const endTime = document.getElementById("endTime").value;
            if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                if (end < start) end.setDate(end.getDate() + 1);
                const diffHours = (end - start) / (1000 * 60 * 60);
                document.getElementById("totalHours").value = diffHours.toFixed(2);
            }
        }
    </script>
</body>
    </html>
