// 1. إعداد Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCKbEAIcSnw70CqUflBVFuv7KUq1VMjgTA",
    authDomain: "pump-station-system.firebaseapp.com",
    projectId: "pump-station-system",
    databaseURL: "https://pump-station-system-default-rtdb.firebaseio.com",
    storageBucket: "pump-station-system.firebasestorage.app",
    messagingSenderId: "734880960614",
    appId: "1:734880960614:web:79039329fcfe3888181da7"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// متغيرات التحكم بالمزامنة
let currentStationRef = null;
let isUpdating = false;

// تعيين التاريخ الحالي افتراضياً
document.getElementById("record-date").valueAsDate = new Date();

// بيانات الوحدات (طلمبات) الافتراضية
const pumpUnits = [{
    name: "معلومات",
    items: [{
        name: "المنسوب",
        id: "level1",
        unit: "سم",
        inputType: "mixed",
        placeholder: "أدخل المنسوب بالسم"
    }, {
        name: "قراءة عداد الطاقة",
        id: "energy1",
        unit: "ك.و.س",
        inputType: "number",
        placeholder: "أدخل قراءة العداد"
    }, {
        name: "قراءة عداد الطاقة ٢",
        id: "energy2",
        unit: "ك.و.س",
        inputType: "number",
        placeholder: "أدخل القراءة الثانية"
    }, {
        name: "الجهد",
        id: "voltage1",
        unit: "فولت",
        inputType: "number",
        placeholder: "أدخل الجهد بالفولت"
    }, {
        name: "الضغط",
        id: "daght",
        unit: "بار",
        inputType: "number",
        placeholder: "أدخل الضغط بالبار"
    }]
}, {
    name: "الوحدة رقم ١",
    type: "unit",
    unitNumber: 1,
    items: [{
        name: "إجمالي عدد الساعات",
        id: "totalHours1",
        unit: "ساعة",
        inputType: "number",
        placeholder: "أدخل عدد الساعات"
    }, {
        name: "فتحة محبس الطرد (%)",
        id: "valve1",
        unit: "%",
        inputType: "number",
        placeholder: "أدخل النسبة المئوية"
    }, {
        name: "ضغط سحب المضخة",
        id: "suction1",
        unit: "بار",
        inputType: "number",
        placeholder: "أدخل الضغط بالبار"
    }, {
        name: "ضغط طرد المضخة",
        id: "discharge1",
        unit: "بار",
        inputType: "number",
        placeholder: "أدخل الضغط بالبار"
    }, {
        name: "حالة حرارة كرسي التحميل",
        id: "bearing1",
        unit: "°C",
        inputType: "mixed",
        placeholder: "أدخل الحرارة أو الحالة"
    }, {
        name: "حالة الحشو",
        id: "seal1",
        unit: "",
        inputType: "text",
        placeholder: "أدخل حالة الحشو"
    }, {
        name: "درجة حرارة الموتور",
        id: "motorTemp1",
        unit: "",
        inputType: "mixed",
        placeholder: "أدخل درجة الحرارة أو الحالة"
    }, {
        name: "شدة تيار الموتور",
        id: "motorCurrent1",
        unit: "أمبير",
        inputType: "number",
        placeholder: "أدخل شدة التيار"
    }]
}, {
    name: "الوحدة رقم ٢",
    type: "unit",
    unitNumber: 2,
    items: [{
        name: "إجمالي عدد الساعات",
        id: "totalHours2",
        unit: "ساعة",
        inputType: "number",
        placeholder: "أدخل عدد الساعات"
    }, {
        name: "فتحة محبس الطرد (%)",
        id: "valve2",
        unit: "%",
        inputType: "number",
        placeholder: "أدخل النسبة المئوية"
    }, {
        name: "ضغط سحب المضخة",
        id: "suction2",
        unit: "بار",
        inputType: "number",
        placeholder: "أدخل الضغط بالبار"
    }, {
        name: "ضغط طرد المضخة",
        id: "discharge2",
        unit: "بار",
        inputType: "number",
        placeholder: "أدخل الضغط بالبار"
    }, {
        name: "حالة حرارة كرسي التحميل",
        id: "bearing2",
        unit: "°C",
        inputType: "mixed",
        placeholder: "أدخل الحرارة أو الحالة"
    }, {
        name: "حالة الحشو",
        id: "seal2",
        unit: "",
        inputType: "text",
        placeholder: "أدخل حالة الحشو"
    }, {
        name: "درجة حرارة الموتور",
        id: "motorTemp2",
        unit: "",
        inputType: "mixed",
        placeholder: "أدخل درجة الحرارة أو الحالة"
    }, {
        name: "شدة تيار الموتور",
        id: "motorCurrent2",
        unit: "أمبير",
        inputType: "number",
        placeholder: "أدخل شدة التيار"
    }]
}];

// أوقات القراءة
const timeSlots = ["6:00", "11:00", "16:00", "21:00", "2:00"];

// إنشاء الجدول
const tableBody = document.getElementById("tableBody");

function generateTable() {
    tableBody.innerHTML = "";

    const sortedUnits = [...pumpUnits];
    sortedUnits.sort((a, b) => {
        if (a.name === "معلومات") return -1;
        if (b.name === "معلومات") return 1;
        if (a.unitNumber && b.unitNumber) {
            return a.unitNumber - b.unitNumber;
        }
        return 0;
    });

    sortedUnits.forEach((unit) => {
        const unitHeaderRow = document.createElement("tr");
        const unitHeaderCell = document.createElement("td");
        unitHeaderCell.colSpan = 6;
        unitHeaderCell.textContent = unit.name;
        unitHeaderCell.className = "unit-header";
        unitHeaderRow.appendChild(unitHeaderCell);
        tableBody.appendChild(unitHeaderRow);

        unit.items.forEach((item) => {
            const row = document.createElement("tr");

            const nameCell = document.createElement("td");
            nameCell.textContent = item.name;
            row.appendChild(nameCell);

            timeSlots.forEach((time, timeIndex) => {
                const inputCell = document.createElement("td");
                const input = document.createElement("input");

                if (item.inputType === "number") {
                    input.type = "text";
                    input.inputMode = "decimal";
                    input.className = "data-input keyboard-number number-input";
                    input.pattern = "[0-9]*";
                } else if (item.inputType === "mixed") {
                    input.type = "text";
                    input.inputMode = "text";
                    input.className = "data-input keyboard-mixed mixed-input";
                } else {
                    input.type = "text";
                    input.inputMode = "text";
                    input.className = "data-input keyboard-text text-input";
                }

                input.placeholder = item.placeholder || (item.unit ? `أدخل ${item.unit}` : "أدخل القيمة");
                input.id = `${item.id}_${timeIndex}`;
                input.setAttribute("data-unit", item.unit || "");
                input.setAttribute("data-item-name", item.name);
                input.setAttribute("data-time-slot", time);
                input.setAttribute("autocomplete", "off");

                if (item.inputType === "mixed") {
                    input.setAttribute("data-mixed", "true");
                }

                inputCell.appendChild(input);
                row.appendChild(inputCell);
            });

            tableBody.appendChild(row);
        });
    });
}

document.addEventListener("DOMContentLoaded", function() {
    generateTable();
    setupAutoSave();
    checkSyncOnStart();
});

// نظام المزامنة باستخدام اسم المحطة كمعرف
function syncByStationName() {
    const stationName = document.getElementById('station-name').value.trim();
    const statusEl = document.getElementById('sync-status');

    if (!stationName) {
        statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> أدخل اسم المحطة';
        statusEl.className = 'status-indicator syncing';
        return;
    }

    // تحديث حقل المزامنة
    document.getElementById('sync-code').value = stationName;

    // إظهار حالة الجلب
    statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> جاري جلب البيانات...';
    statusEl.className = 'status-indicator syncing';

    // إغلاق الاتصال القديم إذا كان موجوداً
    if (currentStationRef) currentStationRef.off();

    // إنشاء رابط للمحطة باستخدام اسمها (مع ترميز الآمن للعربية)
    const stationId = encodeURIComponent(stationName);
    currentStationRef = database.ref('pump_stations/' + stationId);

    // الاستماع لأي تحديثات (مباشر)
    currentStationRef.on('value', (snapshot) => {
        const data = snapshot.val();

        if (data) {
            // ملء البيانات في الواجهة
            fillUIWithStationData(data);
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> تم جلب آخر تحديث';
            statusEl.className = 'status-indicator online';
            
            // عرض تنبيه بآخر تحديث
            showLastUpdateInfo(data);
        } else {
            statusEl.innerHTML = '<i class="fas fa-info-circle"></i> محطة جديدة - جاهزة للحفظ';
            statusEl.className = 'status-indicator';
        }
    });
}

// دالة ملء البيانات في الواجهة
function fillUIWithStationData(data) {
    if (isUpdating) return;
    isUpdating = true;

    // ملء الحقول الأساسية
    if (data.station) document.getElementById('station-name').value = data.station;
    if (data.operator) document.getElementById('operator-name').value = data.operator;
    if (data.date) document.getElementById('record-date').value = data.date;
    if (data.shift) document.getElementById('shift').value = data.shift;

    // ملء بيانات الجدول
    if (data.inputs) {
        Object.entries(data.inputs).forEach(([id, value]) => {
            const input = document.getElementById(id);
            if (input) input.value = value;
        });
    }

    // ملء البيانات الإضافية
    if (data.additional) {
        document.getElementById('waterPath').value = data.additional.waterPath || '';
        document.getElementById('tank1Level').value = data.additional.tank1 || '';
        document.getElementById('tank2Level').value = data.additional.tank2 || '';
        document.getElementById('tank3Level').value = data.additional.tank3 || '';
        document.getElementById('compressor1').value = data.additional.comp1 || '';
        document.getElementById('compressor2').value = data.additional.comp2 || '';
        document.getElementById('com').value = data.additional.com || '';
        document.getElementById('startTime').value = data.additional.start || '06:00';
        document.getElementById('endTime').value = data.additional.end || '24:00';
        document.getElementById('dailyNotes').value = data.additional.notes || '';
    }

    // حساب ساعات التشغيل
    calculateTotalHours();
    
    isUpdating = false;
}

// دالة الحفظ التلقائي في السحابة
function autoSaveToCloud() {
    const stationName = document.getElementById('station-name').value.trim();
    if (!stationName || isUpdating) return;

    const stationId = encodeURIComponent(stationName);
    const statusEl = document.getElementById('sync-status');
    
    statusEl.innerHTML = '<i class="fas fa-sync fa-spin"></i> جاري الحفظ...';
    statusEl.className = 'status-indicator syncing';

    const data = {
        station: stationName,
        operator: document.getElementById('operator-name').value,
        date: document.getElementById('record-date').value,
        shift: document.getElementById('shift').value,
        inputs: {},
        additional: {
            waterPath: document.getElementById('waterPath').value,
            tank1: document.getElementById('tank1Level').value,
            tank2: document.getElementById('tank2Level').value,
            tank3: document.getElementById('tank3Level').value,
            comp1: document.getElementById('compressor1').value,
            comp2: document.getElementById('compressor2').value,
            com: document.getElementById('com').value,
            start: document.getElementById('startTime').value,
            end: document.getElementById('endTime').value,
            notes: document.getElementById('dailyNotes').value
        },
        lastUpdatedBy: document.getElementById('operator-name').value || 'مشغل',
        lastUpdate: firebase.database.ServerValue.TIMESTAMP
    };

    // جمع بيانات الجدول
    document.querySelectorAll('.data-input').forEach(input => {
        if (input.value) data.inputs[input.id] = input.value;
    });

    database.ref('pump_stations/' + stationId).set(data)
        .then(() => {
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i> تم المزامنة';
            statusEl.className = 'status-indicator online';
        })
        .catch(error => {
            console.error('Error saving to cloud:', error);
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> خطأ في الحفظ';
            statusEl.className = 'status-indicator';
        });
}

// إعداد الحفظ التلقائي
function setupAutoSave() {
    let saveTimer;
    
    // مراقبة جميع الحقول
    const allInputs = document.querySelectorAll('input, textarea, select');
    allInputs.forEach(input => {
        input.addEventListener('input', () => {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(autoSaveToCloud, 2000);
        });
        input.addEventListener('change', () => {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(autoSaveToCloud, 1000);
        });
    });

    // حفظ كل 5 دقائق كنسخة احتياطية
    setInterval(autoSaveToCloud, 300000);
}

// التحقق من المزامنة عند البدء
function checkSyncOnStart() {
    const lastStation = localStorage.getItem('last_sync_station');
    if (lastStation) {
        document.getElementById('station-name').value = lastStation;
        document.getElementById('sync-code').value = lastStation;
        syncByStationName();
    }
}

// عرض معلومات آخر تحديث
function showLastUpdateInfo(data) {
    if (data.lastUpdate) {
        const updateTime = new Date(data.lastUpdate).toLocaleString('ar-EG');
        const message = `آخر تحديث: ${updateTime} بواسطة ${data.lastUpdatedBy || 'مشغل'}`;
        
        // عرض تنبيه مؤقت
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: #2c5aa0;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        `;
        alertDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => alertDiv.remove(), 300);
        }, 5000);
    }
}

// استماع لتغيير اسم المحطة
document.getElementById('station-name').addEventListener('change', function() {
    syncByStationName();
    localStorage.setItem('last_sync_station', this.value);
});

// استماع لحقل المزامنة
document.getElementById('sync-code').addEventListener('change', function() {
    const code = this.value.trim();
    if (code) {
        document.getElementById('station-name').value = code;
        syncByStationName();
        localStorage.setItem('last_sync_station', code);
    }
});

// === باقي الدوال الأصلية (مع تعديلات طفيفة) ===

// إضافة وحدة جديدة
document.getElementById("addRowBtn").addEventListener("click", function() {
    let maxUnitNumber = 2;
    pumpUnits.forEach(unit => {
        if (unit.type === "unit" && unit.unitNumber > maxUnitNumber) {
            maxUnitNumber = unit.unitNumber;
        }
    });

    const nextUnitNumber = maxUnitNumber + 1;

    if (nextUnitNumber > 9) {
        alert("الحد الأقصى للوحدات هو 9 وحدات");
        return;
    }

    const newUnit = {
        name: `الوحدة رقم ${unitCountToArabic(nextUnitNumber)}`,
        type: "unit",
        unitNumber: nextUnitNumber,
        items: [{
            name: "إجمالي عدد الساعات",
            id: `totalHours${nextUnitNumber}`,
            unit: "ساعة",
            inputType: "number",
            placeholder: "أدخل عدد الساعات"
        }, {
            name: "فتحة محبس الطرد (%)",
            id: `valve${nextUnitNumber}`,
            unit: "%",
            inputType: "number",
            placeholder: "أدخل النسبة المئوية"
        }, {
            name: "ضغط سحب المضخة",
            id: `suction${nextUnitNumber}`,
            unit: "بار",
            inputType: "number",
            placeholder: "أدخل الضغط بالبار"
        }, {
            name: "ضغط طرد المضخة",
            id: `discharge${nextUnitNumber}`,
            unit: "بار",
            inputType: "number",
            placeholder: "أدخل الضغط بالبار"
        }, {
            name: "حالة حرارة كرسي التحميل",
            id: `bearing${nextUnitNumber}`,
            unit: "°C",
            inputType: "mixed",
            placeholder: "أدخل الحرارة أو الحالة"
        }, {
            name: "حالة الحشو",
            id: `seal${nextUnitNumber}`,
            unit: "",
            inputType: "text",
            placeholder: "أدخل حالة الحشو"
        }, {
            name: "درجة حرارة الموتور",
            id: `motorTemp${nextUnitNumber}`,
            unit: "",
            inputType: "mixed",
            placeholder: "أدخل درجة الحرارة أو الحالة"
        }, {
            name: "شدة تيار الموتور",
            id: `motorCurrent${nextUnitNumber}`,
            unit: "أمبير",
            inputType: "number",
            placeholder: "أدخل شدة التيار"
        }]
    };

    pumpUnits.push(newUnit);
    generateTable();
    autoSaveToCloud(); // حفظ بعد التعديل

    setTimeout(() => {
        const unitHeaders = document.querySelectorAll('.unit-header');
        if (unitHeaders.length > 0) {
            const newUnitHeader = unitHeaders[unitHeaders.length - 1];
            newUnitHeader.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }
    }, 100);
});

// تحويل الأرقام إلى العربية
function unitCountToArabic(num) {
    const arabicNumbers = ["٠", "١", "٢", "٣", "٤", "٥", "٦", "٧", "٨", "٩"];
    if (num < 10) {
        return arabicNumbers[num];
    }
    return num.toString();
}

// إعادة تعيين النموذج (مع الحفظ السحابي)
document.getElementById("resetBtn").addEventListener("click", function() {
    if (confirm("هل تريد إعادة تعيين جميع البيانات؟")) {
        // حفظ نسخة احتياطية قبل الإعادة
        const stationName = document.getElementById('station-name').value;
        if (stationName) {
            const backupData = {
                station: stationName,
                operator: document.getElementById('operator-name').value,
                date: document.getElementById('record-date').value,
                inputs: {}
            };
            
            document.querySelectorAll('.data-input').forEach(input => {
                if (input.value) backupData.inputs[input.id] = input.value;
            });
            
            localStorage.setItem('last_backup_' + stationName, JSON.stringify(backupData));
        }

        // إعادة التعيين
        document.getElementById("station-name").value = "محطة الضخ الرئيسية";
        document.getElementById("operator-name").value = "";
        document.getElementById("record-date").valueAsDate = new Date();
        document.getElementById("shift").value = "صباحية";

        document.getElementById("waterPath").value = "";
        document.getElementById("tank1Level").value = "";
        document.getElementById("tank2Level").value = "";
        document.getElementById("tank3Level").value = "";
        document.getElementById("compressor1").value = "";
        document.getElementById("compressor2").value = "";
        document.getElementById("com").value = "";
        document.getElementById("startTime").value = "06:00";
        document.getElementById("endTime").value = "24:00";
        document.getElementById("totalHours").value = "";
        document.getElementById("dailyNotes").value = "";

        document.querySelectorAll('.data-input').forEach(input => {
            input.value = "";
        });

        while (pumpUnits.length > 3) {
            pumpUnits.pop();
        }

        generateTable();
        calculateTotalHours();
        autoSaveToCloud(); // حفظ الحالة الجديدة
        
        alert("تم إعادة تعيين النموذج بنجاح");
    }
});

// طباعة النموذج
document.getElementById("printBtn").addEventListener("click", function() {
    window.print();
});

// تصدير إلى Excel
document.getElementById("exportBtn").addEventListener("click", exportToExcel);

function exportToExcel() {
    const wsData = [];
    wsData.push(["سجل محطة ضخ - بيانات المحطة"]);
    wsData.push([]);
    wsData.push(["اسم المحطة", document.getElementById("station-name").value]);
    wsData.push(["اسم المشغل", document.getElementById("operator-name").value]);
    wsData.push(["التاريخ", document.getElementById("record-date").value]);
    wsData.push(["الوردية", document.getElementById("shift").value]);
    wsData.push(["آخر تحديث", new Date().toLocaleString('ar-EG')]);
    wsData.push([]);
    wsData.push(["بيانات الوحدات"]);
    wsData.push([]);

    const tableHeaders = ["البيان", "6:00 ص", "11:00 ص", "4:00 م", "9:00 م", "2:00 ص"];
    wsData.push(tableHeaders);

    const rows = document.querySelectorAll("#pumpTable tbody tr");
    rows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll("td");
        cells.forEach((cell, index) => {
            if (index === 0) {
                rowData.push(cell.textContent);
            } else if (index <= 5) {
                const input = cell.querySelector("input");
                const value = input ? input.value : cell.textContent;
                const unit = input ? input.getAttribute("data-unit") : "";

                if (value) {
                    if (unit && unit.trim() !== "") {
                        rowData.push(`${value} ${unit}`);
                    } else {
                        rowData.push(value);
                    }
                } else {
                    rowData.push("");
                }
            }
        });
        if (rowData.length > 0) {
            wsData.push(rowData);
        }
    });

    wsData.push([]);
    wsData.push(["بيانات إضافية"]);
    wsData.push([]);

    const additionalData = [
        ["الطرق المائي", document.getElementById("waterPath").value],
        ["مستوي المياه بالخزان الأول", document.getElementById("tank1Level").value],
        ["مستوي المياه بالخزان الثاني", document.getElementById("tank2Level").value],
        ["مستوي المياه بالخزان الثالث", document.getElementById("tank3Level").value],
        ["مستوي الزيت بالضاغط الأول / درجة الحرارة", document.getElementById("compressor1").value],
        ["مستوي الزيت بالضاغط الثاني / درجة الحرارة", document.getElementById("compressor2").value],
        ["مستوي الزيت بالضاغط / درجة الحرارة", document.getElementById("com").value],
        ["توقيت تشغيل المحطة", document.getElementById("startTime").value],
        ["توقيت إيقاف المحطة", document.getElementById("endTime").value],
        ["عدد ساعات تشغيل المحطة خلال اليوم", document.getElementById("totalHours").value],
        ["ملاحظات اليوم", document.getElementById("dailyNotes").value]
    ];

    additionalData.forEach(item => {
        wsData.push(item);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    const wscols = [{
        wch: 30
    }, {
        wch: 20
    }, {
        wch: 20
    }, {
        wch: 20
    }, {
        wch: 20
    }, {
        wch: 20
    }];
    ws["!cols"] = wscols;

    XLSX.utils.book_append_sheet(wb, ws, "سجل محطة الضخ");

    const stationName = document.getElementById("station-name").value || "محطة الضخ";
    const date = document.getElementById("record-date").value || new Date().toISOString().split("T")[0];
    const fileName = `${stationName}_${date}.xlsx`;

    XLSX.writeFile(wb, fileName);
    alert("تم تصدير البيانات إلى ملف Excel بنجاح");
}

// حساب عدد ساعات التشغيل تلقائياً
document.getElementById("startTime").addEventListener("change", calculateTotalHours);
document.getElementById("endTime").addEventListener("change", calculateTotalHours);

function calculateTotalHours() {
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;

    if (startTime && endTime) {
        const start = new Date(`2000-01-01T${startTime}`);
        const end = new Date(`2000-01-01T${endTime}`);

        if (end < start) {
            end.setDate(end.getDate() + 1);
        }

        const diffMs = end - start;
        const diffHours = diffMs / (1000 * 60 * 60);

        document.getElementById("totalHours").value = diffHours.toFixed(2);
    }
}

calculateTotalHours();

// تحسينات للجوال
document.addEventListener('touchstart', function() {}, {
    passive: true
});

document.addEventListener('focusin', function(event) {
    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
        setTimeout(() => {
            event.target.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 300);
    }
});

// إضافة أنميشن للتنبيهات
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
